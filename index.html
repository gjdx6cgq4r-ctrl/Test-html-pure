<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>ApiGest - Debug Mode</title>

    <!-- CONFIGURATION APPLE PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- STYLE GLOBAL -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'rucher-yellow': '#F4CE5E',
              'rucher-green': '#5E7048',
              'rucher-bg': '#FAF9F4',
              'rucher-dark': '#2A331E',
              honey: { 50: '#FAF9F4', 100: '#fffbd1', 500: '#F4CE5E', 600: '#dcb955', 700: '#5E7048', 800: '#2A331E', 900: '#1a2012' }
            },
            fontFamily: { serif: ['"Playfair Display"', 'serif'], sans: ['"Lato"', 'sans-serif'] }
          }
        }
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- DEPENDANCES (UMD - Chargement direct) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { background-color: #FAF9F4; color: #2A331E; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ERROR OVERLAY STYLE */
        #error-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: white; color: #b91c1c; z-index: 10000;
            padding: 20px; overflow: auto; font-family: monospace;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0",
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "jspdf": "https://esm.sh/jspdf@^3.0.4",
    "jspdf-autotable": "https://esm.sh/jspdf-autotable@^5.0.2"
  }
}
</script>
</head>
<body>
    <!-- ZONE D'AFFICHAGE DES ERREURS (Invisible sauf si crash) -->
    <div id="error-overlay">
        <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">⚠️ Une erreur est survenue</h1>
        <p style="margin-bottom: 10px; color: #333;">Prenez une capture d'écran de ce message pour le diagnostic :</p>
        <pre id="error-content" style="background: #fef2f2; padding: 15px; border: 1px solid #f87171; border-radius: 8px; white-space: pre-wrap;"></pre>
        <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px;">Recharger la page</button>
    </div>

    <!-- SCRIPT DE DEBUG (Capture toutes les erreurs) -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('error-overlay').style.display = 'block';
            document.getElementById('error-content').innerText = 
                "Message: " + message + "\n" +
                "Source: " + source + "\n" +
                "Ligne: " + lineno + ":" + colno + "\n" +
                "Stack: " + (error ? error.stack : 'N/A');
            return false;
        };
        window.onunhandledrejection = function(event) {
            document.getElementById('error-overlay').style.display = 'block';
            document.getElementById('error-content').innerText += "\n\nPromise Rejection: " + event.reason;
        };
    </script>

    <div id="root"></div>

    <!-- APPLICATION COMPLETE (Babel Script) -->
    <script type="text/babel">
        // --- 0. INITIALISATION ---
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            LayoutDashboard, Settings, MapPin, Plus, Trash2, Save, Wallet, 
            TrendingUp, TrendingDown, PackageCheck, AlertTriangle, X, 
            ChevronDown, ChevronRight, ShoppingCart, Archive, Package, Store, 
            User, Users, History, Edit2, Check, Search, Download, Upload, 
            FileText, Syringe, Truck, Utensils, Clock, MoreHorizontal, Phone, Mail, Medal,
            Tag, Calendar, BookOpen, Droplets, BookOpenText, Layers, Coins, ImagePlus, ArrowDown, ArrowUp, ArrowUpDown, PlusCircle, Loader2
        } = lucideReact;

        // --- 1. UTILITAIRES ---
        const generateId = () => 'id_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        const normalizeString = (str) => (!str ? '' : str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '').trim());
        const getYearFromDateStr = (dateStr) => {
            if (!dateStr) return new Date().getFullYear();
            const parts = dateStr.split('-');
            return parts.length > 0 ? parseInt(parts[0]) : new Date(dateStr).getFullYear();
        };
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600; 
                        const scaleSize = MAX_WIDTH / img.width;
                        if (scaleSize < 1) {
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                        } else {
                            canvas.width = img.width;
                            canvas.height = img.height;
                        }
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // --- 2. STORAGE (Données) ---
        const STORAGE_KEYS = {
            PROFILE: 'apigest_profile_v3', APIARIES: 'apigest_apiaries_v3', HIVES: 'apigest_hives_v3', 
            MOVEMENTS: 'apigest_movements_v3', INTERVENTIONS: 'apigest_interventions_v3', FEEDINGS: 'apigest_feedings_v3',
            HARVESTS: 'apigest_harvests_v3', PACKAGING: 'apigest_packaging_v3', SALES: 'apigest_sales_v3',
            PRODUCTS: 'apigest_products_v3', HONEY_TYPES: 'apigest_honey_types_v3', FOOD_TYPES: 'apigest_food_types_v3',
            EXPENSES: 'apigest_expenses_v3', CLIENTS: 'apigest_clients_v3', COST_CONFIG: 'apigest_cost_config_v3',
        };

        const get = (key, def) => { try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; } };
        const set = (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) { console.error(e); } };

        // Managers
        const createListManager = (key, defaultList = []) => ({
            getAll: () => get(key, defaultList),
            add: (item) => { const l = get(key, defaultList); l.push(item); set(key, l); },
            update: (item) => { const l = get(key, defaultList); const i = l.findIndex(x=>x.id===item.id); if(i>=0)l[i]=item; set(key, l); },
            delete: (id) => set(key, get(key, defaultList).filter(x=>x.id!==id))
        });

        // Données Initiales
        const SAMPLE_PROFILE = { companyName: 'Le Rucher Du Vieux Juigné', status: 'Micro BA' };
        const SAMPLE_APIARIES = [{id:'demo_api', name:'Rucher Démo', location:'Jardin'}];
        const SAMPLE_HIVES = [{id:'demo_hive', name:'Ruche 01', apiaryId:'demo_api'}];

        // Objet Storage Global
        const Storage = {
            generateId,
            getProfile: () => get(STORAGE_KEYS.PROFILE, SAMPLE_PROFILE),
            saveProfile: (p) => set(STORAGE_KEYS.PROFILE, p),
            getApiaries: () => get(STORAGE_KEYS.APIARIES, SAMPLE_APIARIES),
            saveApiary: (a) => { const l = get(STORAGE_KEYS.APIARIES, SAMPLE_APIARIES); const i = l.findIndex(x=>x.id===a.id); if(i>=0) l[i]=a; else l.push(a); set(STORAGE_KEYS.APIARIES, l); },
            deleteApiary: (id) => set(STORAGE_KEYS.APIARIES, get(STORAGE_KEYS.APIARIES, SAMPLE_APIARIES).filter(x=>x.id!==id)),
            
            hives: createListManager(STORAGE_KEYS.HIVES, SAMPLE_HIVES),
            movements: createListManager(STORAGE_KEYS.MOVEMENTS),
            interventions: createListManager(STORAGE_KEYS.INTERVENTIONS),
            feedings: createListManager(STORAGE_KEYS.FEEDINGS),
            harvests: createListManager(STORAGE_KEYS.HARVESTS),
            packaging: createListManager(STORAGE_KEYS.PACKAGING),
            sales: createListManager(STORAGE_KEYS.SALES),
            products: createListManager(STORAGE_KEYS.PRODUCTS),
            expenses: createListManager(STORAGE_KEYS.EXPENSES),
            clients: createListManager(STORAGE_KEYS.CLIENTS),
            
            getHoneyTypes: () => get(STORAGE_KEYS.HONEY_TYPES, ['Toutes fleurs', 'Acacia', 'Printemps', 'Été', 'Châtaignier']),
            saveHoneyTypes: (t) => set(STORAGE_KEYS.HONEY_TYPES, t),
            getFoodTypes: () => get(STORAGE_KEYS.FOOD_TYPES, ['Sirop 50/50', 'Candi', 'Sirop stimulation']),
            saveFoodTypes: (t) => set(STORAGE_KEYS.FOOD_TYPES, t),
            getCostConfig: () => get(STORAGE_KEYS.COST_CONFIG, { jar250: 0.3, jar500: 0.45, jar1kg: 0.6, lid: 0.15, label250: 0.1, label500: 0.1, label1kg: 0.12, feedingYearly: 0, treatmentYearly: 0 }),
            saveCostConfig: (c) => set(STORAGE_KEYS.COST_CONFIG, c),

            exportAllData: () => {
                const data = {};
                Object.keys(STORAGE_KEYS).forEach(k => data[k] = get(STORAGE_KEYS[k], []));
                return JSON.stringify({version:'3.0', timestamp: new Date().toISOString(), data});
            },
            importAllData: (json) => {
                try {
                    const parsed = JSON.parse(json);
                    if(!parsed.data) return false;
                    Object.keys(parsed.data).forEach(k => {
                        const foundKey = Object.keys(STORAGE_KEYS).find(sk => sk === k || STORAGE_KEYS[sk] === k);
                        if(foundKey) set(STORAGE_KEYS[foundKey], parsed.data[k]);
                    });
                    return true;
                } catch(e) { return false; }
            }
        };

        // --- 3. PDF SERVICE ---
        const PDFService = {
            generateDoc: (title, start, end) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const profile = Storage.getProfile();
                doc.setFontSize(18); doc.setTextColor(42, 51, 30);
                doc.text(profile.companyName || "Apiculture", 14, 20);
                doc.setFontSize(10); doc.setTextColor(100);
                let y = 26;
                doc.text(profile.address || '', 14, y);
                if(profile.address) y+=6;
                doc.text(`NAPI: ${profile.napi || '-'} | SIRET: ${profile.siret || '-'}`, 14, y);
                y+=6;
                doc.setDrawColor(244, 206, 94); doc.line(14, y+4, 196, y+4);
                doc.setFontSize(14); doc.setTextColor(0);
                doc.text(`${title} (${new Date(start).toLocaleDateString()} - ${new Date(end).toLocaleDateString()})`, 14, y+14);
                return {doc, y: y+24};
            },
            filter: (arr, s, e) => arr.filter(i => i.date >= s && i.date <= e),
            
            generateBreedingRegisterPDF: (s, e) => {
                const {doc, y} = PDFService.generateDoc("Registre d'Élevage", s, e);
                const interventions = PDFService.filter(Storage.interventions.getAll(), s, e);
                doc.setFontSize(12); doc.text("Traitements", 14, y);
                doc.autoTable({ startY: y+4, head: [['Date', 'Médicament', 'Lot', 'Qté']], body: interventions.map(i => [i.date, i.drugName, i.batchNumber, i.quantity]), theme:'grid', headStyles:{fillColor:[220, 38, 38]} });
                doc.save('registre_elevage.pdf');
            },
            generateHoneyTraceabilityPDF: (s, e) => {
                const {doc, y} = PDFService.generateDoc("Cahier de Miellerie", s, e);
                const harvests = PDFService.filter(Storage.harvests.getAll(), s, e);
                doc.setFontSize(12); doc.text("Récoltes", 14, y);
                doc.autoTable({ startY: y+4, head: [['Date', 'Miel', 'Kg', 'Lot']], body: harvests.map(h => [h.date, h.honeyType, h.quantityKg, h.batchId]), theme:'grid', headStyles:{fillColor:[217, 119, 6]} });
                doc.save('miellerie.pdf');
            },
            generateSalesPDF: (s, e) => {
                const {doc, y} = PDFService.generateDoc("Ventes", s, e);
                const sales = PDFService.filter(Storage.sales.getAll(), s, e);
                doc.autoTable({ startY: y, head: [['Date', 'Client', 'Produit', 'Total']], body: sales.map(sa => [sa.date, sa.buyerName, sa.productName, sa.totalPrice+'€']), theme:'grid', headStyles:{fillColor:[22, 163, 74]} });
                doc.save('ventes.pdf');
            }
        };

        // --- 4. COMPOSANTS UI ---
        
        const HiveIcon = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect x="3" y="3" width="18" height="4" rx="1" />
                <rect x="5" y="7" width="14" height="11" />
                <path d="M9 14h6" />
                <path d="M6 18v3" />
                <path d="M18 18v3" />
            </svg>
        );

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
                        <h3 className="text-xl font-bold text-red-600 mb-4">{title}</h3>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <div className="flex gap-3 justify-end">
                            <button onClick={onCancel} className="px-4 py-2 bg-gray-100 rounded-lg">Annuler</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-lg">Confirmer</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 5. COMPOSANTS METIERS (Simplifiés pour éviter les erreurs de syntaxe TS) ---

        const ClientManager = () => {
            const [clients, setClients] = useState([]);
            const [formData, setFormData] = useState({ name: '', phone: '', email: '', address: '' });
            const [editingId, setEditingId] = useState(null);
            
            useEffect(() => refresh(), []);
            const refresh = () => setClients(Storage.clients.getAll());

            const save = () => {
                if(!formData.name) return;
                const id = editingId || Storage.generateId();
                if(editingId) Storage.clients.update({...formData, id});
                else Storage.clients.add({...formData, id});
                setFormData({ name: '', phone: '', email: '', address: '' }); setEditingId(null); refresh();
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h2 className="text-xl font-bold mb-4">Clients</h2>
                        <div className="flex flex-col gap-2 mb-4">
                            <input placeholder="Nom" className="border p-2 rounded" value={formData.name} onChange={e=>setFormData({...formData, name:e.target.value})} />
                            <input placeholder="Tel" className="border p-2 rounded" value={formData.phone} onChange={e=>setFormData({...formData, phone:e.target.value})} />
                            <button onClick={save} className="bg-blue-600 text-white p-2 rounded font-bold">Enregistrer</button>
                        </div>
                        <div className="space-y-2">
                            {clients.map(c => (
                                <div key={c.id} className="p-3 border rounded flex justify-between bg-gray-50">
                                    <span>{c.name}</span>
                                    <button onClick={()=>{Storage.clients.delete(c.id); refresh();}}><Trash2 size={16} className="text-red-500"/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const Expenses = () => {
            const [expenses, setExpenses] = useState([]);
            const [newExp, setNewExp] = useState({date: new Date().toISOString().split('T')[0], description:'', amount:0, category:'MATERIEL'});
            
            useEffect(() => refresh(), []);
            const refresh = () => setExpenses(Storage.expenses.getAll());

            const add = () => {
                if(!newExp.description || !newExp.amount) return;
                Storage.expenses.add({...newExp, id:Storage.generateId()});
                refresh();
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h2 className="text-xl font-bold mb-4">Dépenses</h2>
                        <div className="flex gap-2 mb-4">
                            <input type="text" placeholder="Description" className="border p-2 rounded flex-1" value={newExp.description} onChange={e=>setNewExp({...newExp, description:e.target.value})} />
                            <input type="number" placeholder="Montant" className="border p-2 rounded w-24" value={newExp.amount || ''} onChange={e=>setNewExp({...newExp, amount:parseFloat(e.target.value)})} />
                            <button onClick={add} className="bg-red-600 text-white px-4 rounded font-bold">+</button>
                        </div>
                        <div className="space-y-2">
                            {expenses.map(e => (
                                <div key={e.id} className="p-3 border rounded flex justify-between">
                                    <span>{e.description}</span>
                                    <span className="font-bold text-red-600">-{e.amount}€</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const BreedingRegister = () => {
            const [activeTab, setActiveTab] = useState('APIARY');
            const [apiaries, setApiaries] = useState([]);
            const [hives, setHives] = useState([]);
            const [interventions, setInterventions] = useState([]);
            
            const [newInt, setNewInt] = useState({date: new Date().toISOString().split('T')[0], drugName: '', batchNumber: '', quantity: '', apiaryId: ''});

            useEffect(() => refresh(), []);
            const refresh = () => {
                setApiaries(Storage.getApiaries());
                setHives(Storage.hives.getAll());
                setInterventions(Storage.interventions.getAll());
            };

            return (
                <div className="space-y-6">
                    <div className="flex gap-2 overflow-x-auto pb-2">
                        {['APIARY','SANITARY'].map(t => (
                            <button key={t} onClick={()=>setActiveTab(t)} className={`px-4 py-2 rounded-full font-bold border ${activeTab===t?'bg-honey-600 text-white':'bg-white'}`}>{t==='APIARY'?'Ruchers':'Soins'}</button>
                        ))}
                    </div>

                    {activeTab === 'APIARY' && (
                        <div>
                            <button onClick={()=>{const n=prompt('Nom du rucher?'); if(n) {Storage.saveApiary({id:Storage.generateId(), name:n, location:''}); refresh();}}} className="bg-honey-500 text-white px-4 py-2 rounded mb-4 font-bold">+ Nouveau Rucher</button>
                            {apiaries.map(a => (
                                <div key={a.id} className="bg-white p-4 rounded border mb-2">
                                    <div className="font-bold text-lg">{a.name}</div>
                                    <div className="flex flex-wrap gap-2 mt-2">
                                        {hives.filter(h=>h.apiaryId===a.id).map(h => (
                                            <span key={h.id} className="px-2 py-1 bg-honey-50 border rounded text-xs flex items-center gap-1"><HiveIcon size={12}/> {h.name}</span>
                                        ))}
                                        <button onClick={()=>{Storage.hives.add({id:Storage.generateId(), name:'Ruche '+(hives.length+1), apiaryId:a.id}); refresh();}} className="px-2 py-1 bg-blue-100 rounded text-xs font-bold text-blue-600">+</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {activeTab === 'SANITARY' && (
                        <div className="bg-white p-4 rounded border">
                            <h3 className="font-bold mb-2">Nouveau Traitement</h3>
                            <div className="grid grid-cols-2 gap-2 mb-2">
                                <input type="text" placeholder="Médicament" className="border p-2 rounded" value={newInt.drugName} onChange={e=>setNewInt({...newInt, drugName:e.target.value})} />
                                <input type="text" placeholder="Lot" className="border p-2 rounded" value={newInt.batchNumber} onChange={e=>setNewInt({...newInt, batchNumber:e.target.value})} />
                            </div>
                            <button onClick={()=>{if(newInt.drugName){Storage.interventions.add({...newInt, id:Storage.generateId()}); refresh();}}} className="w-full bg-red-600 text-white p-2 rounded font-bold mb-4">Enregistrer</button>
                            {interventions.map(i => (
                                <div key={i.id} className="p-2 border-b">
                                    <div className="font-bold">{i.drugName} (Lot: {i.batchNumber})</div>
                                    <div className="text-xs text-gray-500">{i.date}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const HoneyTraceability = () => {
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);
            
            useEffect(() => { setProducts(Storage.products.getAll()); }, []);

            const addToCart = (p) => {
                setCart(prev => {
                    const ex = prev.find(x => x.product.id === p.id);
                    if(ex) return prev.map(x => x.product.id === p.id ? {...x, qty: x.qty+1} : x);
                    return [...prev, {product: p, qty: 1}];
                });
            };

            const checkout = () => {
                cart.forEach(item => {
                    Storage.sales.add({
                        id: Storage.generateId(),
                        date: new Date().toISOString().split('T')[0],
                        productName: item.product.name,
                        quantitySold: item.qty,
                        totalPrice: item.qty * item.product.price
                    });
                });
                setCart([]);
                alert("Vente enregistrée !");
            };

            return (
                <div className="flex flex-col md:flex-row gap-6">
                    <div className="flex-1">
                        <h2 className="text-xl font-bold mb-4">Caisse</h2>
                        <div className="grid grid-cols-2 gap-4">
                            {products.map(p => (
                                <button key={p.id} onClick={()=>addToCart(p)} className="p-4 border rounded bg-white text-left hover:shadow-md">
                                    <div className="font-bold">{p.name}</div>
                                    <div className="text-green-600 font-bold">{p.price} €</div>
                                </button>
                            ))}
                            <button onClick={()=>{
                                const n = prompt('Nom du produit?'); 
                                const pr = prompt('Prix?');
                                if(n && pr) { Storage.products.add({id:Storage.generateId(), name:n, price:parseFloat(pr), potSize:'500g'}); setProducts(Storage.products.getAll()); }
                            }} className="p-4 border rounded bg-gray-50 text-center font-bold text-gray-500">+ Ajouter Produit</button>
                        </div>
                    </div>
                    <div className="w-full md:w-80 bg-white p-4 rounded shadow border h-fit">
                        <h3 className="font-bold border-b pb-2 mb-2">Panier ({cart.reduce((a,b)=>a+b.qty,0)})</h3>
                        {cart.map((it, idx) => (
                            <div key={idx} className="flex justify-between text-sm mb-1">
                                <span>{it.product.name} x{it.qty}</span>
                                <span>{(it.product.price * it.qty).toFixed(2)}€</span>
                            </div>
                        ))}
                        <div className="mt-4 pt-2 border-t font-bold text-xl text-right">
                            {cart.reduce((a,b)=>a+(b.qty*b.product.price),0).toFixed(2)} €
                        </div>
                        <button onClick={checkout} disabled={cart.length===0} className="w-full bg-green-600 text-white p-3 rounded font-bold mt-4 disabled:opacity-50">Encaisser</button>
                    </div>
                </div>
            );
        };

        // --- 6. APP PRINCIPALE ---
        const App = () => {
            const [view, setView] = useState('DASHBOARD');
            const [profile, setProfile] = useState({});

            useEffect(() => {
                setProfile(Storage.getProfile());
            }, []);

            const NavItem = ({id, label, icon: Icon}) => (
                <button onClick={() => setView(id)} className={`flex flex-col md:flex-row items-center justify-center md:justify-start p-3 md:px-6 rounded-lg transition-all mb-1 ${view===id ? 'bg-rucher-yellow text-rucher-dark font-bold shadow-sm' : 'text-gray-400 hover:text-rucher-green hover:bg-rucher-bg'}`}>
                    <Icon size={22} className="mb-1 md:mb-0 md:mr-3" />
                    <span className="text-xs md:text-sm uppercase tracking-wide">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen flex flex-col md:flex-row font-sans text-gray-800">
                    <nav className="fixed bottom-0 left-0 w-full bg-white border-t border-rucher-yellow z-50 md:relative md:w-64 md:h-screen md:border-t-0 md:border-r md:flex md:flex-col p-4 shadow-2xl md:shadow-none safe-area-bottom">
                        <div className="hidden md:flex flex-col items-center mb-10 pt-4">
                            <div className="w-24 h-24 rounded-full border-4 border-rucher-yellow flex items-center justify-center bg-white shadow-md mb-3">
                                <span className="font-serif font-bold text-2xl text-rucher-dark">AG</span>
                            </div>
                            <h1 className="font-serif text-lg font-bold text-rucher-dark text-center leading-tight">{profile.companyName || 'ApiGest'}</h1>
                        </div>
                        <div className="flex justify-between md:flex-col md:gap-2 px-2 md:px-0">
                            <NavItem id="DASHBOARD" label="Accueil" icon={LayoutDashboard} />
                            <NavItem id="BREEDING" label="Ruchers" icon={MapPin} />
                            <NavItem id="HONEY" label="Miellerie" icon={Store} />
                            <NavItem id="EXPENSES" label="Dépenses" icon={Wallet} />
                            <NavItem id="CLIENTS" label="Clients" icon={Users} />
                            <NavItem id="SETTINGS" label="Réglages" icon={Settings} />
                        </div>
                    </nav>

                    <main className="flex-1 pb-24 md:pb-8 p-4 md:p-8 overflow-y-auto h-screen relative bg-gray-50">
                        <div className="max-w-6xl mx-auto">
                            {/* HEADER MOBILE */}
                            <div className="md:hidden flex items-center justify-between mb-6 pb-4 border-b border-rucher-yellow">
                                <span className="font-serif font-bold text-rucher-dark text-lg">ApiGest</span>
                            </div>

                            {view === 'DASHBOARD' && (
                                <div className="space-y-8 animate-in fade-in duration-500">
                                    <header className="text-center md:text-left">
                                        <h1 className="font-serif text-3xl md:text-4xl text-rucher-dark mb-2">Bienvenue</h1>
                                        <p className="text-rucher-green font-light italic">{profile.companyName || 'Mon Rucher'}</p>
                                    </header>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div onClick={()=>setView('HONEY')} className="bg-rucher-green text-white p-6 rounded-xl shadow-lg cursor-pointer flex flex-col items-center justify-center text-center">
                                            <ShoppingCart size={32} className="mb-2 text-rucher-yellow"/>
                                            <h3 className="font-serif text-2xl">Caisse Rapide</h3>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'BREEDING' && <BreedingRegister />}
                            {view === 'HONEY' && <HoneyTraceability />}
                            {view === 'EXPENSES' && <Expenses />}
                            {view === 'CLIENTS' && <ClientManager />}
                            
                            {view === 'SETTINGS' && (
                                <div className="bg-white p-8 rounded-xl shadow-sm max-w-2xl mx-auto border border-gray-100">
                                    <h2 className="font-serif text-2xl text-rucher-dark mb-6 border-b border-rucher-yellow pb-2">Paramètres</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-rucher-green uppercase mb-1">Nom Exploitation</label>
                                            <input type="text" className="w-full border p-3 rounded bg-rucher-bg text-rucher-dark font-serif" value={profile.companyName||''} onChange={e=>{const p={...profile, companyName:e.target.value}; setProfile(p); Storage.saveProfile(p);}} />
                                        </div>
                                        <button onClick={() => {
                                            const data = Storage.exportAllData();
                                            const blob = new Blob([data], {type: 'application/json'});
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = `backup_apigest_${new Date().toISOString().split('T')[0]}.json`;
                                            a.click();
                                        }} className="w-full bg-gray-100 text-gray-600 py-3 rounded font-bold flex items-center justify-center gap-2 hover:bg-gray-200 transition">
                                            <Download size={18}/> Sauvegarder mes données
                                        </button>
                                        <label className="w-full bg-blue-50 text-blue-600 py-3 rounded font-bold flex items-center justify-center gap-2 hover:bg-blue-100 transition cursor-pointer">
                                            <Upload size={18}/> Restaurer une sauvegarde
                                            <input type="file" accept=".json" className="hidden" onChange={(e) => {
                                                const file = e.target.files[0];
                                                if(file) {
                                                    const reader = new FileReader();
                                                    reader.onload = (ev) => {
                                                        if(Storage.importAllData(ev.target.result)) {
                                                            alert('Restauration réussie !');
                                                            window.location.reload();
                                                        } else {
                                                            alert('Fichier invalide');
                                                        }
                                                    };
                                                    reader.readAsText(file);
                                                }
                                            }}/>
                                        </label>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>