<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>ApiGest - Le Rucher Du Vieux Juign√©</title>

    <!-- CONFIGURATION APPLE (Je les laisse comme demand√©, ce n'est pas la cause du bug) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ApiGest">

    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- LIBRAIRIES (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'rucher-yellow': '#F4CE5E',
              'rucher-green': '#5E7048',
              'rucher-bg': '#FAF9F4',
              'rucher-dark': '#2A331E',
              honey: { 50: '#FAF9F4', 100: '#fffbd1', 500: '#F4CE5E', 600: '#dcb955', 700: '#5E7048', 800: '#2A331E', 900: '#1a2012' }
            },
            fontFamily: { serif: ['"Playfair Display"', 'serif'], sans: ['"Lato"', 'sans-serif'] }
          }
        }
      }
    </script>
    
    <!-- REACT & TOOLS (Version Globale UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- ICONS & PDF -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* ANIMATIONS */
        @keyframes flyBee {
            0% { transform: scale(0.5) translateY(0) rotate(0deg); opacity: 1; }
            20% { transform: scale(1.2) translateY(-40px) rotate(-10deg); opacity: 1; }
            50% { transform: scale(1.2) translateY(-20px) translateX(50px) rotate(10deg); opacity: 1; }
            100% { transform: scale(0.1) translateY(400px) translateX(300px) rotate(45deg); opacity: 0; }
        }
        .animate-fly-bee { animation: flyBee 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; pointer-events: none; z-index: 9999; }
        
        @keyframes flyCart {
            0% { transform: scale(0.5) translateY(0) rotate(0deg); opacity: 1; }
            40% { transform: scale(1.5) translateY(-30px) rotate(-10deg); opacity: 1; }
            100% { transform: scale(0.2) translateY(300px) translateX(200px) rotate(45deg); opacity: 0; }
        }
        .animate-fly-cart { animation: flyCart 0.8s ease-in-out forwards; pointer-events: none; z-index: 9999; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        body { background-color: #FAF9F4; color: #2A331E; }
    </style>
<script type="importmap">
{
  "imports": {
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "jspdf": "https://esm.sh/jspdf@^3.0.4",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "jspdf-autotable": "https://esm.sh/jspdf-autotable@^5.0.2"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 0. VARIABLES GLOBALES ---
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            LayoutDashboard, Settings, MapPin, Plus, Trash2, Save, Wallet, 
            TrendingUp, TrendingDown, PackageCheck, AlertTriangle, X, 
            ChevronDown, ChevronRight, ShoppingCart, Archive, Package, Store, 
            User, Users, History, Edit2, Check, Search, Download, Upload, 
            FileText, Syringe, Truck, Utensils, Clock, MoreHorizontal, Phone, Mail, Medal,
            Tag, Calendar, BookOpen, Droplets, BookOpenText, Layers, Coins, ImagePlus, ArrowDown, ArrowUp, ArrowUpDown, PlusCircle, Loader2
        } = lucideReact;

        // --- 1. SERVICES (Stockage & PDF) ---
        const generateId = () => 'id_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        const normalizeString = (str) => (!str ? '' : str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '').trim());
        const getYearFromDateStr = (dateStr) => dateStr ? (dateStr.split('-')[0] || new Date(dateStr).getFullYear()) : new Date().getFullYear();

        const STORAGE_KEYS = {
            PROFILE: 'apigest_profile_v3', APIARIES: 'apigest_apiaries_v3', HIVES: 'apigest_hives_v3', 
            MOVEMENTS: 'apigest_movements_v3', INTERVENTIONS: 'apigest_interventions_v3', FEEDINGS: 'apigest_feedings_v3',
            HARVESTS: 'apigest_harvests_v3', PACKAGING: 'apigest_packaging_v3', SALES: 'apigest_sales_v3',
            PRODUCTS: 'apigest_products_v3', HONEY_TYPES: 'apigest_honey_types_v3', FOOD_TYPES: 'apigest_food_types_v3',
            EXPENSES: 'apigest_expenses_v3', CLIENTS: 'apigest_clients_v3', COST_CONFIG: 'apigest_cost_config_v3',
        };

        const get = (key, def) => { try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; } };
        const set = (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) { alert("M√©moire pleine !"); } };

        const createListManager = (key, defaultList = []) => ({
            getAll: () => get(key, defaultList),
            add: (item) => { const l = get(key, defaultList); l.push(item); set(key, l); },
            update: (item) => { const l = get(key, defaultList); const i = l.findIndex(x=>x.id===item.id); if(i>=0)l[i]=item; set(key, l); },
            delete: (id) => set(key, get(key, defaultList).filter(x=>x.id!==id))
        });

        const Storage = {
            generateId,
            getProfile: () => get(STORAGE_KEYS.PROFILE, { companyName: 'Le Rucher Du Vieux Juign√©', status: 'Micro BA' }),
            saveProfile: (p) => set(STORAGE_KEYS.PROFILE, p),
            getApiaries: () => get(STORAGE_KEYS.APIARIES, []),
            saveApiary: (a) => { const l = get(STORAGE_KEYS.APIARIES, []); const i = l.findIndex(x=>x.id===a.id); if(i>=0) l[i]=a; else l.push(a); set(STORAGE_KEYS.APIARIES, l); },
            deleteApiary: (id) => set(STORAGE_KEYS.APIARIES, get(STORAGE_KEYS.APIARIES, []).filter(x=>x.id!==id)),
            
            hives: createListManager(STORAGE_KEYS.HIVES),
            movements: createListManager(STORAGE_KEYS.MOVEMENTS),
            interventions: createListManager(STORAGE_KEYS.INTERVENTIONS),
            feedings: createListManager(STORAGE_KEYS.FEEDINGS),
            harvests: createListManager(STORAGE_KEYS.HARVESTS),
            packaging: createListManager(STORAGE_KEYS.PACKAGING),
            sales: createListManager(STORAGE_KEYS.SALES),
            products: createListManager(STORAGE_KEYS.PRODUCTS),
            expenses: createListManager(STORAGE_KEYS.EXPENSES),
            clients: createListManager(STORAGE_KEYS.CLIENTS),
            
            getHoneyTypes: () => get(STORAGE_KEYS.HONEY_TYPES, ['Toutes fleurs', 'Acacia', 'Printemps', '√ât√©', 'Ch√¢taignier']),
            saveHoneyTypes: (t) => set(STORAGE_KEYS.HONEY_TYPES, t),
            getFoodTypes: () => get(STORAGE_KEYS.FOOD_TYPES, ['Sirop 50/50', 'Candi', 'Sirop stimulation']),
            saveFoodTypes: (t) => set(STORAGE_KEYS.FOOD_TYPES, t),
            getCostConfig: () => get(STORAGE_KEYS.COST_CONFIG, { jar250: 0.3, jar500: 0.45, jar1kg: 0.6, lid: 0.15, label250: 0.1, label500: 0.1, label1kg: 0.12, feedingYearly: 0, treatmentYearly: 0 }),
            saveCostConfig: (c) => set(STORAGE_KEYS.COST_CONFIG, c),

            exportAllData: () => {
                const data = {};
                Object.keys(STORAGE_KEYS).forEach(k => data[k] = get(STORAGE_KEYS[k], []));
                return JSON.stringify({version:'3.0', timestamp: new Date().toISOString(), data});
            },
            importAllData: (json) => {
                try {
                    const parsed = JSON.parse(json);
                    if(!parsed.data) return false;
                    Object.keys(parsed.data).forEach(k => {
                        const foundKey = Object.keys(STORAGE_KEYS).find(sk => sk === k || STORAGE_KEYS[sk] === k);
                        if(foundKey) set(STORAGE_KEYS[foundKey], parsed.data[k]);
                    });
                    return true;
                } catch(e) { return false; }
            }
        };

        const PDFService = {
            generateDoc: (title, start, end) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const profile = Storage.getProfile();
                doc.setFontSize(18);
                doc.setTextColor(42, 51, 30);
                doc.text(profile.companyName || "Apiculture", 14, 20);
                doc.setFontSize(10);
                doc.setTextColor(100);
                let y = 26;
                doc.text(profile.address || '', 14, y);
                if(profile.address) y+=6;
                doc.text(`NAPI: ${profile.napi} | SIRET: ${profile.siret}`, 14, y);
                y+=6;
                doc.setDrawColor(244, 206, 94);
                doc.line(14, y+4, 196, y+4);
                doc.setFontSize(14);
                doc.setTextColor(0);
                doc.text(`${title} (${new Date(start).toLocaleDateString()} - ${new Date(end).toLocaleDateString()})`, 14, y+14);
                return {doc, y: y+20};
            },
            generateSalesPDF: (s, e) => {
                const {doc, y} = PDFService.generateDoc("Livre de Recettes", s, e);
                const sales = Storage.sales.getAll().filter(i => i.date >= s && i.date <= e);
                doc.autoTable({ startY: y, head: [['Date', 'Produit', 'Prix', 'Paiement']], body: sales.map(x => [x.date, x.productName, x.totalPrice + '‚Ç¨', x.paymentMethod]), theme:'grid', headStyles:{fillColor:[94, 112, 72]} });
                doc.save('ventes.pdf');
            }
        };

        // --- 2. COMPOSANTS UI ---
        const HiveIcon = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect x="3" y="3" width="18" height="4" rx="1" />
                <rect x="5" y="7" width="14" height="11" />
                <path d="M9 14h6" />
                <path d="M6 18v3" />
                <path d="M18 18v3" />
            </svg>
        );

        const SimpleDonutChart = ({ data }) => {
            const total = data.reduce((sum, item) => sum + item.value, 0);
            if (total === 0) return <div className="h-40 flex items-center justify-center text-gray-400 text-xs">Pas de donn√©es</div>;
            let currentAngle = 0;
            const gradientParts = data.map(item => {
                const percentage = (item.value / total) * 100;
                const start = currentAngle;
                const end = currentAngle + percentage;
                currentAngle = end;
                return `${item.color} ${start}% ${end}%`;
            });
            return (
                <div className="flex flex-col items-center justify-center">
                    <div className="relative w-32 h-32 rounded-full mb-4 shadow-sm" style={{ background: `conic-gradient(${gradientParts.join(', ')})` }}>
                        <div className="absolute inset-4 bg-white rounded-full flex items-center justify-center flex-col">
                            <span className="text-xs text-gray-400">Total</span>
                            <span className="font-bold text-gray-800">{total.toFixed(0)}‚Ç¨</span>
                        </div>
                    </div>
                    <div className="w-full space-y-1">
                        {data.map((item, idx) => (
                            <div key={idx} className="flex justify-between text-xs items-center">
                                <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full" style={{ background: item.color }}></span><span className="text-gray-600">{item.name}</span></div>
                                <span className="font-bold">{item.value.toFixed(0)} ‚Ç¨</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SimpleBarChart = ({ data }) => {
            const max = Math.max(...data.map(d => d.value), 1);
            if(data.length === 0) return <div className="h-40 flex items-center justify-center text-gray-400 text-xs">Pas de donn√©es</div>;
            return (
                <div className="space-y-3 w-full">
                    {data.map((item, idx) => (
                        <div key={idx} className="w-full">
                            <div className="flex justify-between text-xs mb-1"><span className="font-medium text-gray-700">{item.name}</span><span className="font-bold text-honey-600">{item.value.toFixed(0)} ‚Ç¨</span></div>
                            <div className="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden"><div className="bg-honey-500 h-2.5 rounded-full" style={{ width: `${(item.value / max) * 100}%` }}></div></div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- 3. MODULES METIERS ---

        // >>> CLIENTS <<<
        const ClientManager = () => {
            const [clients, setClients] = useState([]);
            const [sales, setSales] = useState([]);
            const [formData, setFormData] = useState({ name: '', phone: '', email: '', address: '' });
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => refreshData(), []);
            const refreshData = () => { setClients(Storage.clients.getAll()); setSales(Storage.sales.getAll()); };
            
            const handleSaveClient = () => {
                if (!formData.name) return;
                const id = editingId || Storage.generateId();
                if(editingId) Storage.clients.update({ ...formData, id }); else Storage.clients.add({ ...formData, id });
                setFormData({ name: '', phone: '', email: '', address: '' }); setEditingId(null); refreshData();
            };
            
            const sortedClients = clients.map(c => ({
                ...c, 
                totalSpent: sales.filter(s => s.clientId === c.id || s.buyerName === c.name).reduce((sum, s) => sum + (s.totalPrice || 0), 0)
            })).sort((a,b) => b.totalSpent - a.totalSpent).filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 rounded-xl text-white shadow-md">
                        <h2 className="text-2xl font-bold flex items-center gap-2"><Users /> Gestion des Clients</h2>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 md:col-span-1 h-fit">
                            <h3 className="font-bold text-gray-800 mb-4">{editingId ? "Modifier" : "Nouveau"}</h3>
                            <input type="text" placeholder="Nom *" className="w-full border p-2 rounded mb-2" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})}/>
                            <input type="text" placeholder="Tel" className="w-full border p-2 rounded mb-2" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})}/>
                            <input type="text" placeholder="Email" className="w-full border p-2 rounded mb-2" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})}/>
                            <button onClick={handleSaveClient} className="w-full bg-blue-600 text-white p-2 rounded font-bold">Enregistrer</button>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm md:col-span-2">
                            <input type="text" placeholder="Rechercher..." className="w-full border p-2 rounded mb-4" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/>
                            <div className="space-y-2 max-h-[400px] overflow-y-auto">
                                {sortedClients.map(client => (
                                    <div key={client.id} className="flex justify-between p-3 border rounded items-center bg-gray-50">
                                        <div>
                                            <div className="font-bold">{client.name}</div>
                                            <div className="text-xs text-gray-500">{client.phone} | Achat: {client.totalSpent.toFixed(2)}‚Ç¨</div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={()=>{setEditingId(client.id); setFormData(client);}} className="text-blue-500"><Edit2 size={16}/></button>
                                            <button onClick={()=>{if(confirm('Supprimer?')) {Storage.clients.delete(client.id); refreshData();}}} className="text-red-500"><Trash2 size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // >>> DEPENSES <<<
        const Expenses = () => {
            const [expenses, setExpenses] = useState([]);
            const [newExpense, setNewExpense] = useState({ date: new Date().toISOString().split('T')[0], store: '', description: '', category: 'MATERIEL', amount: '' });
            useEffect(() => setExpenses(Storage.expenses.getAll().sort((a,b)=>new Date(b.date)-new Date(a.date))), []);
            
            const handleAdd = () => {
                if(!newExpense.amount) return;
                Storage.expenses.add({ ...newExpense, id: Storage.generateId(), amount: parseFloat(newExpense.amount) });
                setNewExpense({ ...newExpense, description: '', amount: '' });
                setExpenses(Storage.expenses.getAll().sort((a,b)=>new Date(b.date)-new Date(a.date)));
            };

            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-red-600 to-red-500 p-6 rounded-xl text-white shadow-md">
                        <h2 className="text-2xl font-bold flex items-center gap-2"><Wallet /> D√©penses</h2>
                        <div className="mt-2 text-3xl font-bold">{expenses.reduce((a,b)=>a+b.amount,0).toFixed(2)} ‚Ç¨</div>
                    </div>
                    <div className="bg-white p-6 rounded-xl border border-gray-100">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-2">
                            <input type="date" className="border p-2 rounded" value={newExpense.date} onChange={e=>setNewExpense({...newExpense, date: e.target.value})}/>
                            <input type="text" placeholder="Magasin" className="border p-2 rounded" value={newExpense.store} onChange={e=>setNewExpense({...newExpense, store: e.target.value})}/>
                            <input type="text" placeholder="Article" className="border p-2 rounded" value={newExpense.description} onChange={e=>setNewExpense({...newExpense, description: e.target.value})}/>
                            <input type="number" placeholder="Montant" className="border p-2 rounded" value={newExpense.amount} onChange={e=>setNewExpense({...newExpense, amount: e.target.value})}/>
                        </div>
                        <button onClick={handleAdd} className="mt-2 w-full bg-red-600 text-white p-2 rounded font-bold">Ajouter D√©pense</button>
                    </div>
                    <div className="space-y-2 max-h-[400px] overflow-y-auto">
                        {expenses.map(exp => (
                            <div key={exp.id} className="flex justify-between p-3 bg-white border rounded items-center">
                                <div><div className="font-bold">{exp.store}</div><div className="text-xs text-gray-500">{exp.description} ({new Date(exp.date).toLocaleDateString()})</div></div>
                                <div className="font-bold text-red-600">-{exp.amount.toFixed(2)}‚Ç¨</div>
                                <button onClick={()=>{Storage.expenses.delete(exp.id); setExpenses(Storage.expenses.getAll().sort((a,b)=>new Date(b.date)-new Date(a.date)));}} className="ml-2 text-gray-300 hover:text-red-500"><Trash2 size={16}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // >>> ELEVAGE <<<
        const BreedingRegister = () => {
            const [activeTab, setActiveTab] = useState('APIARY');
            const [apiaries, setApiaries] = useState([]);
            const [hives, setHives] = useState([]);
            const [interventions, setInterventions] = useState([]);
            const [newInt, setNewInt] = useState({date: new Date().toISOString().split('T')[0], drugName: '', batchNumber: '', quantity: '', apiaryId: ''});

            useEffect(() => { 
                setApiaries(Storage.getApiaries()); 
                setHives(Storage.hives.getAll()); 
                setInterventions(Storage.interventions.getAll());
            }, []);

            const addIntervention = () => {
                if(!newInt.drugName) return;
                Storage.interventions.add({...newInt, id:Storage.generateId()});
                setInterventions(Storage.interventions.getAll());
                setNewInt({...newInt, drugName:'', batchNumber:''});
            };

            return (
                <div className="space-y-6">
                    <div className="flex gap-2 mb-4 overflow-x-auto">
                        {[{id:'APIARY',label:'Ruchers',icon:MapPin}, {id:'SANITARY',label:'Soins',icon:Syringe}].map(t => (
                            <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`flex items-center gap-2 px-4 py-2 rounded-full font-bold border ${activeTab===t.id?'bg-honey-600 text-white':'bg-white'}`}>
                                <t.icon size={16}/> {t.label}
                            </button>
                        ))}
                    </div>
                    {activeTab === 'APIARY' && (
                        <div className="space-y-2">
                            {apiaries.map(apiary => (
                                <div key={apiary.id} className="bg-white border rounded-xl p-4">
                                    <h3 className="font-bold text-lg">{apiary.name}</h3>
                                    <p className="text-gray-500 text-xs mb-2">{apiary.location}</p>
                                    <div className="flex flex-wrap gap-2">
                                        {hives.filter(h=>h.apiaryId===apiary.id).map(hive => (
                                            <span key={hive.id} className="px-2 py-1 bg-honey-50 border border-honey-100 rounded text-xs font-bold text-honey-700 flex items-center gap-1">
                                                <HiveIcon size={12}/> {hive.name}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    {activeTab === 'SANITARY' && (
                        <div>
                             <div className="bg-white p-4 rounded-xl border mb-4">
                                 <h3 className="font-bold mb-2">Nouveau Traitement</h3>
                                 <input type="date" className="border p-2 rounded w-full mb-2" value={newInt.date} onChange={e=>setNewInt({...newInt, date:e.target.value})}/>
                                 <select className="border p-2 rounded w-full mb-2" value={newInt.drugName} onChange={e=>setNewInt({...newInt, drugName:e.target.value})}>
                                     <option value="">M√©dicament...</option>
                                     {['Apivar', 'Apitraz', 'Acide Oxalique'].map(t=><option key={t} value={t}>{t}</option>)}
                                 </select>
                                 <input type="text" placeholder="N¬∞ Lot (Obligatoire)" className="border p-2 rounded w-full mb-2" value={newInt.batchNumber} onChange={e=>setNewInt({...newInt, batchNumber:e.target.value})}/>
                                 <button onClick={addIntervention} className="w-full bg-red-600 text-white p-2 rounded font-bold">Enregistrer</button>
                             </div>
                             <div className="space-y-2">
                                 {interventions.map(i => (
                                     <div key={i.id} className="p-3 bg-white border rounded">
                                         <div className="font-bold">{i.drugName}</div>
                                         <div className="text-xs text-gray-500">Lot: {i.batchNumber} | {new Date(i.date).toLocaleDateString()}</div>
                                         <button onClick={()=>{Storage.interventions.delete(i.id); setInterventions(Storage.interventions.getAll());}} className="text-red-400 text-xs mt-1">Supprimer</button>
                                     </div>
                                 ))}
                             </div>
                        </div>
                    )}
                </div>
            );
        };

        // >>> MIELLERIE & CAISSE <<<
        const HoneyTraceability = ({ initialTab }) => {
            const [activeTab, setActiveTab] = useState(initialTab || 'POS');
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);
            const [animatingItems, setAnimatingItems] = useState([]);
            const [packagings, setPackagings] = useState([]);
            const [honeyTypes, setHoneyTypes] = useState([]);
            
            useEffect(() => { 
                setProducts(Storage.products.getAll()); 
                setPackagings(Storage.packaging.getAll());
                setHoneyTypes(Storage.getHoneyTypes());
                setActiveTab(initialTab || 'POS'); 
            }, [initialTab]);

            const addToCart = (p) => {
                const key = Date.now();
                setAnimatingItems(prev => [...prev, {id: p.id, key}]);
                setTimeout(() => setAnimatingItems(prev => prev.filter(i => i.key !== key)), 800);
                setCart(prev => {
                    const ex = prev.find(x => x.product.id === p.id);
                    if(ex) return prev.map(x => x.product.id === p.id ? {...x, quantity: x.quantity+1} : x);
                    return [...prev, {product: p, quantity: 1}];
                });
            };

            const handleCheckout = () => {
                const total = cart.reduce((a,b)=>a+(b.quantity*b.product.price),0);
                cart.forEach(item => {
                    Storage.sales.add({
                        id: Storage.generateId(),
                        date: new Date().toISOString().split('T')[0],
                        productName: item.product.name,
                        quantitySold: item.quantity,
                        totalPrice: item.quantity * item.product.price,
                        paymentMethod: 'ESPECES',
                        finalBatchNumber: item.product.currentBatchId ? 'LOT-AUTO' : 'VRAC'
                    });
                });
                setCart([]);
                alert(`Vente de ${total.toFixed(2)}‚Ç¨ enregistr√©e !`);
            };

            return (
                <div className="h-full">
                     <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                        {[{id:'POS', label:'Caisse', icon:ShoppingCart}, {id:'PRODUCTS', label:'Produits', icon:Store}, {id:'PACKAGING', label:'Mise en pot', icon:Package}].map(t => (
                            <button key={t.id} onClick={() => setActiveTab(t.id)} className={`flex items-center gap-2 px-5 py-2 rounded-full text-sm font-bold tracking-wide transition shadow-sm ${activeTab===t.id ? 'bg-rucher-yellow text-rucher-dark' : 'bg-white text-gray-500 border border-gray-200'}`}>
                                <t.icon size={16}/> {t.label}
                            </button>
                        ))}
                     </div>

                     {activeTab === 'POS' && (
                         <div className="flex flex-col md:flex-row gap-6 h-full">
                             <div className="flex-1">
                                 <h2 className="font-serif text-2xl mb-4 text-rucher-dark">Catalogue</h2>
                                 <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                     {products.map(p => (
                                         <button key={p.id} onClick={() => addToCart(p)} className="relative bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:border-rucher-yellow hover:shadow-md transition text-left group overflow-visible select-none">
                                             {animatingItems.filter(i => i.id === p.id).map(anim => (
                                                <div key={anim.key} className="absolute inset-0 flex items-center justify-center pointer-events-none z-50 animate-fly-cart"><div className="text-4xl filter drop-shadow-lg transform -scale-x-100">üêù</div></div>
                                             ))}
                                             <div className="h-24 bg-rucher-bg rounded mb-3 flex items-center justify-center relative">
                                                 {p.imageUrl ? <img src={p.imageUrl} className="h-full object-contain"/> : <Store size={32} className="text-rucher-green opacity-30"/>}
                                                 <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition text-rucher-yellow"><Plus size={20}/></div>
                                             </div>
                                             <div className="font-bold text-rucher-dark truncate">{p.name}</div>
                                             <div className="text-rucher-green font-bold mt-1">{p.price.toFixed(2)} ‚Ç¨</div>
                                             <div className="text-xs text-gray-400">{p.potSize}</div>
                                         </button>
                                     ))}
                                     {products.length === 0 && <div className="col-span-full text-center py-10 text-gray-400 font-serif italic">Aucun produit. Allez dans "Produits" pour en cr√©er.</div>}
                                 </div>
                             </div>
                             
                             <div className="w-full md:w-80 bg-white shadow-xl border border-gray-100 rounded-xl p-5 flex flex-col h-fit sticky top-4">
                                 <h3 className="font-serif text-xl border-b border-rucher-yellow pb-3 mb-3 flex justify-between items-center text-rucher-dark">
                                     <span>Panier</span>
                                     <span className="bg-rucher-yellow text-rucher-dark px-2 py-1 rounded-full text-xs font-bold">{cart.reduce((a,b)=>a+b.quantity,0)}</span>
                                 </h3>
                                 <div className="flex-1 overflow-y-auto space-y-3 min-h-[200px]">
                                     {cart.map((item, idx) => (
                                         <div key={idx} className="flex justify-between text-sm items-center border-b border-dashed border-gray-100 pb-2">
                                             <div><div className="font-bold text-gray-800">{item.product.name}</div><div className="text-xs text-gray-500">x{item.quantity}</div></div>
                                             <div className="font-bold text-rucher-green">{(item.quantity * item.product.price).toFixed(2)}‚Ç¨</div>
                                         </div>
                                     ))}
                                     {cart.length === 0 && <div className="text-gray-400 italic text-center mt-10">Panier vide</div>}
                                 </div>
                                 <div className="border-t border-gray-200 pt-4 mt-2">
                                     <div className="flex justify-between font-serif text-2xl mb-4 text-rucher-dark"><span>Total</span><span>{cart.reduce((a,b)=>a+(b.quantity*b.product.price),0).toFixed(2)} ‚Ç¨</span></div>
                                     <button onClick={handleCheckout} disabled={cart.length===0} className="w-full bg-rucher-green text-white py-3 rounded shadow-md font-bold hover:bg-rucher-dark transition disabled:opacity-50">Encaisser</button>
                                 </div>
                             </div>
                         </div>
                     )}
                     
                     {activeTab === 'PRODUCTS' && (
                         <div className="bg-white p-6 rounded-xl shadow-sm">
                             <h2 className="font-serif text-2xl mb-4">Produits</h2>
                             <div className="flex gap-2">
                                 <input id="newProdName" placeholder="Nom (ex: Miel Acacia)" className="border p-2 rounded flex-1"/>
                                 <input id="newProdPrice" placeholder="Prix" type="number" className="border p-2 rounded w-24"/>
                                 <button onClick={() => {
                                     const name = document.getElementById('newProdName').value;
                                     const price = parseFloat(document.getElementById('newProdPrice').value);
                                     if(name && price) {
                                         Storage.products.add({id:Storage.generateId(), name, price, potSize:'500g'});
                                         setProducts(Storage.products.getAll());
                                     }
                                 }} className="bg-rucher-yellow px-4 rounded font-bold text-rucher-dark">Ajouter</button>
                             </div>
                             <div className="mt-4 space-y-2">
                                 {products.map(p => <div key={p.id} className="p-2 border-b flex justify-between"><span>{p.name}</span><span className="font-bold">{p.price}‚Ç¨</span></div>)}
                             </div>
                         </div>
                     )}

                     {activeTab === 'PACKAGING' && (
                        <div className="bg-white p-6 rounded-xl shadow-sm">
                            <h2 className="font-serif text-2xl mb-4">Cr√©er un Lot</h2>
                            <p className="text-sm text-gray-500 mb-4">G√©n√©rez un num√©ro de lot pour la tra√ßabilit√©.</p>
                            <input className="w-full border p-2 rounded mb-2" placeholder="Num√©ro de Lot (ex: 2025-01-AC)" id="batchNum"/>
                            <input className="w-full border p-2 rounded mb-2" type="number" placeholder="Quantit√© de pots" id="batchQty"/>
                            <button onClick={()=>{
                                const num = document.getElementById('batchNum').value;
                                const qty = document.getElementById('batchQty').value;
                                if(num && qty) {
                                    Storage.packaging.add({id:Storage.generateId(), date: new Date().toISOString(), finalBatchNumber: num, quantityPots: qty, potSize: '500g'});
                                    setPackagings(Storage.packaging.getAll());
                                    alert('Lot cr√©√©');
                                }
                            }} className="w-full bg-amber-500 text-white p-2 rounded font-bold">Enregistrer Mise en Pot</button>
                            
                            <div className="mt-4 space-y-2">
                                {packagings.map(p => <div key={p.id} className="text-sm p-2 bg-gray-50 border rounded flex justify-between"><span>Lot: {p.finalBatchNumber}</span><span>{p.quantityPots} pots</span></div>)}
                            </div>
                        </div>
                     )}
                </div>
            );
        };

        // --- 4. APP PRINCIPALE ---
        const App = () => {
            const [view, setView] = useState('DASHBOARD');
            const [honeyTab, setHoneyTab] = useState('POS');
            const [profile, setProfile] = useState({});
            const [dashboardData, setDashboardData] = useState({totalSalesYear:0, totalExpensesYear:0});

            useEffect(() => {
                setProfile(Storage.getProfile());
                const sales = Storage.sales.getAll();
                const expenses = Storage.expenses.getAll();
                const totalSales = sales.reduce((sum, s) => sum + (s.totalPrice || 0), 0);
                const totalExp = expenses.reduce((sum, e) => sum + e.amount, 0);
                setDashboardData({totalSalesYear: totalSales, totalExpensesYear: totalExp});
            }, [view]);

            const NavItem = ({id, label, icon: Icon}) => (
                <button onClick={() => setView(id)} className={`flex flex-col md:flex-row items-center justify-center md:justify-start p-3 md:px-6 rounded-lg transition-all mb-1 ${view===id ? 'bg-rucher-yellow text-rucher-dark font-bold shadow-sm' : 'text-gray-400 hover:text-rucher-green hover:bg-rucher-bg'}`}>
                    <Icon size={22} className="mb-1 md:mb-0 md:mr-3" />
                    <span className="text-xs md:text-sm uppercase tracking-wide">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen flex flex-col md:flex-row font-sans text-gray-800">
                    <nav className="fixed bottom-0 left-0 w-full bg-white border-t border-rucher-yellow z-50 md:relative md:w-64 md:h-screen md:border-t-0 md:border-r md:flex md:flex-col p-4 shadow-2xl md:shadow-none safe-area-bottom">
                        <div className="hidden md:flex flex-col items-center mb-10 pt-4">
                            <div className="w-24 h-24 rounded-full border-4 border-rucher-yellow flex items-center justify-center bg-white shadow-md mb-3">
                                <span className="font-serif font-bold text-2xl text-rucher-dark">AG</span>
                            </div>
                            <h1 className="font-serif text-lg font-bold text-rucher-dark text-center leading-tight">Le Rucher Du<br/>Vieux Juign√©</h1>
                        </div>
                        <div className="flex justify-between md:flex-col md:gap-2 px-2 md:px-0">
                            <NavItem id="DASHBOARD" label="Accueil" icon={LayoutDashboard} />
                            <NavItem id="BREEDING" label="Ruchers" icon={HiveIcon} />
                            <NavItem id="HONEY" label="Miellerie" icon={Store} />
                            <NavItem id="EXPENSES" label="D√©penses" icon={Wallet} />
                            <NavItem id="CLIENTS" label="Clients" icon={Users} />
                            <NavItem id="SETTINGS" label="R√©glages" icon={Settings} />
                        </div>
                    </nav>

                    <main className="flex-1 pb-24 md:pb-8 p-4 md:p-8 overflow-y-auto h-screen relative">
                        <div className="max-w-6xl mx-auto">
                            <div className="md:hidden flex items-center justify-between mb-6 pb-4 border-b border-rucher-yellow">
                                <span className="font-serif font-bold text-rucher-dark text-lg">ApiGest</span>
                            </div>

                            {view === 'DASHBOARD' && (
                                <div className="space-y-8 animate-in fade-in duration-500">
                                    <header className="text-center md:text-left">
                                        <h1 className="font-serif text-3xl md:text-4xl text-rucher-dark mb-2">Bienvenue</h1>
                                        <p className="text-rucher-green font-light italic">{profile.companyName}</p>
                                    </header>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div onClick={() => { setView('HONEY'); setHoneyTab('POS'); }} className="bg-rucher-green text-white p-6 rounded-xl shadow-lg cursor-pointer transform hover:scale-105 transition flex flex-col items-center justify-center text-center relative overflow-hidden group">
                                            <div className="absolute inset-0 bg-black/10 group-hover:bg-transparent transition"></div>
                                            <ShoppingCart size={32} className="mb-2 text-rucher-yellow"/>
                                            <h3 className="font-serif text-2xl">Caisse Rapide</h3>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                                            <span className="text-rucher-green uppercase text-xs font-bold tracking-widest mb-2">Recettes</span>
                                            <span className="font-serif text-4xl text-green-600">+{dashboardData.totalSalesYear.toFixed(0)}‚Ç¨</span>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                                            <span className="text-rucher-green uppercase text-xs font-bold tracking-widest mb-2">D√©penses</span>
                                            <span className="font-serif text-4xl text-red-600">-{dashboardData.totalExpensesYear.toFixed(0)}‚Ç¨</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'BREEDING' && <BreedingRegister />}
                            {view === 'HONEY' && <HoneyTraceability initialTab={honeyTab} />}
                            {view === 'EXPENSES' && <Expenses />}
                            {view === 'CLIENTS' && <ClientManager />}
                            
                            {view === 'SETTINGS' && (
                                <div className="bg-white p-8 rounded-xl shadow-sm max-w-2xl mx-auto border border-gray-100">
                                    <h2 className="font-serif text-2xl text-rucher-dark mb-6 border-b border-rucher-yellow pb-2">Param√®tres</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-rucher-green uppercase mb-1">Nom Exploitation</label>
                                            <input type="text" className="w-full border p-3 rounded bg-rucher-bg text-rucher-dark font-serif" value={profile.companyName||''} onChange={e=>{const p={...profile, companyName:e.target.value}; setProfile(p); Storage.saveProfile(p);}} />
                                        </div>
                                        <div className="pt-6">
                                            <button onClick={() => {
                                                const data = Storage.exportAllData();
                                                const blob = new Blob([data], {type: 'application/json'});
                                                const url = URL.createObjectURL(blob);
                                                const a = document.createElement('a');
                                                a.href = url;
                                                a.download = `backup_apigest_${new Date().toISOString().split('T')[0]}.json`;
                                                a.click();
                                            }} className="w-full bg-gray-100 text-gray-600 py-3 rounded font-bold flex items-center justify-center gap-2 hover:bg-gray-200 transition">
                                                <Download size={18}/> Sauvegarder mes donn√©es
                                            </button>
                                            
                                            <label className="mt-2 w-full bg-blue-50 text-blue-600 py-3 rounded font-bold flex items-center justify-center gap-2 hover:bg-blue-100 transition cursor-pointer">
                                                <Upload size={18}/> Restaurer une sauvegarde
                                                <input type="file" accept=".json" className="hidden" onChange={(e) => {
                                                    const file = e.target.files[0];
                                                    if(file) {
                                                        const reader = new FileReader();
                                                        reader.onload = (ev) => {
                                                            if(Storage.importAllData(ev.target.result)) {
                                                                alert('Restauration r√©ussie !');
                                                                window.location.reload();
                                                            } else {
                                                                alert('Fichier invalide');
                                                            }
                                                        };
                                                        reader.readAsText(file);
                                                    }
                                                }}/>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>