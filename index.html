<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>ApiGest - Le Rucher Du Vieux Juign√©</title>

    <!-- CONFIGURATION APPLE PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ApiGest">

    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- LIBRAIRIES (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'rucher-yellow': '#F4CE5E',
              'rucher-green': '#5E7048',
              'rucher-bg': '#FAF9F4',
              'rucher-dark': '#2A331E',
              honey: { 50: '#FAF9F4', 100: '#fffbd1', 500: '#F4CE5E', 600: '#dcb955', 700: '#5E7048', 800: '#2A331E', 900: '#1a2012' }
            },
            fontFamily: { serif: ['"Playfair Display"', 'serif'], sans: ['"Lato"', 'sans-serif'] }
          }
        }
      }
    </script>
    
    <!-- REACT & TOOLS (UMD Globals pour fonctionnement sans build) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- ICONS & PDF -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* ANIMATIONS */
        @keyframes flyBee {
            0% { transform: scale(0.5) translateY(0) rotate(0deg); opacity: 1; }
            20% { transform: scale(1.2) translateY(-40px) rotate(-10deg); opacity: 1; }
            50% { transform: scale(1.2) translateY(-20px) translateX(50px) rotate(10deg); opacity: 1; }
            100% { transform: scale(0.1) translateY(400px) translateX(300px) rotate(45deg); opacity: 0; }
        }
        .animate-fly-bee { animation: flyBee 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; pointer-events: none; z-index: 9999; }
        
        @keyframes flyCart {
            0% { transform: scale(0.5) translateY(0) rotate(0deg); opacity: 1; }
            40% { transform: scale(1.5) translateY(-30px) rotate(-10deg); opacity: 1; }
            100% { transform: scale(0.2) translateY(300px) translateX(200px) rotate(45deg); opacity: 0; }
        }
        .animate-fly-cart { animation: flyCart 0.8s ease-in-out forwards; pointer-events: none; z-index: 9999; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        body { background-color: #FAF9F4; color: #2A331E; }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "jspdf-autotable": "https://esm.sh/jspdf-autotable@^5.0.2",
    "jspdf": "https://esm.sh/jspdf@^3.0.4"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 0. VARIABLES GLOBALES & UTILITAIRES ---
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            LayoutDashboard, Settings, MapPin, Plus, Trash2, Save, Wallet, 
            TrendingUp, TrendingDown, PackageCheck, AlertTriangle, X, 
            ChevronDown, ChevronRight, ShoppingCart, Archive, Package, Store, 
            User, Users, History, Edit2, Check, Search, Download, Upload, 
            FileText, Syringe, Truck, Utensils, Clock, MoreHorizontal, Phone, Mail, Medal,
            Tag, Calendar, BookOpen, Droplets, BookOpenText, Layers, Coins, ImagePlus, ArrowDown, ArrowUp, ArrowUpDown, PlusCircle, Loader2
        } = lucideReact;

        // Utilitaires de base
        const generateId = () => 'id_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        const normalizeString = (str) => (!str ? '' : str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '').trim());
        const getYearFromDateStr = (dateStr) => {
            if (!dateStr) return new Date().getFullYear();
            const parts = dateStr.split('-');
            return parts.length > 0 ? parseInt(parts[0]) : new Date(dateStr).getFullYear();
        };

        // Compression d'image (Critique pour iPad/LocalStorage)
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600; // R√©duit pour optimiser
                        const scaleSize = MAX_WIDTH / img.width;
                        if (scaleSize < 1) {
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                        } else {
                            canvas.width = img.width;
                            canvas.height = img.height;
                        }
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // --- 1. SERVICE DE STOCKAGE (LocalStorage) ---
        // Bas√© sur votre fichier services/storageService.ts avec les cl√©s _v2
        const STORAGE_KEYS = {
            PROFILE: 'apigest_profile_v2',
            APIARIES: 'apigest_apiaries_v2',
            HIVES: 'apigest_hives_v2', 
            MOVEMENTS: 'apigest_movements_v2',
            INTERVENTIONS: 'apigest_interventions_v2',
            FEEDINGS: 'apigest_feedings_v2',
            HARVESTS: 'apigest_harvests_v2',
            PACKAGING: 'apigest_packaging_v2',
            SALES: 'apigest_sales_v2',
            PRODUCTS: 'apigest_products_v2',
            HONEY_TYPES: 'apigest_honey_types_v2',
            FOOD_TYPES: 'apigest_food_types_v2',
            EXPENSES: 'apigest_expenses_v2',
            CLIENTS: 'apigest_clients_v2',
            COST_CONFIG: 'apigest_cost_config_v2',
        };

        // Donn√©es d'exemple (exactement comme dans votre fichier)
        const SAMPLE_PROFILE = { companyName: 'Le Rucher des Saveurs', napi: 'A1234567', siret: '80012345600019', address: '12 Chemin des Abeilles, 49000 Angers', status: 'Micro BA', creationDate: '2020-01-15', vetName: 'Dr. V√©t√©rinaire', vetAddress: 'Clinique Vet, Angers' };
        const SAMPLE_COST_CONFIG = { jar250: 0.30, jar500: 0.45, jar1kg: 0.60, lid: 0.15, label250: 0.10, label500: 0.10, label1kg: 0.12, feedingYearly: 300, treatmentYearly: 150 };
        const SAMPLE_APIARIES = [ { id: 'api_1', name: 'Rucher du Ch√¢teau', location: 'Parc du Ch√¢teau' }, { id: 'api_2', name: 'Rucher For√™t', location: 'For√™t de Juign√©' } ];
        const SAMPLE_HIVES = [ { id: 'h_1', name: 'Ruche 01', apiaryId: 'api_1' }, { id: 'h_2', name: 'Ruche 02', apiaryId: 'api_1' }, { id: 'h_3', name: 'Ruche 03', apiaryId: 'api_1' }, { id: 'h_4', name: 'Ruche 04', apiaryId: 'api_1' }, { id: 'h_5', name: 'Ruche 05', apiaryId: 'api_1' }, { id: 'h_6', name: 'Ruche F1', apiaryId: 'api_2' }, { id: 'h_7', name: 'Ruche F2', apiaryId: 'api_2' }, { id: 'h_8', name: 'Ruche F3', apiaryId: 'api_2' } ];
        const SAMPLE_MOVEMENTS = [ { id: 'mov_1', date: '2024-03-15', type: 'Transhumance', description: 'D√©placement sur Colza', originApiaryId: 'api_1', destinationApiaryId: 'api_2', quantity: 3 } ];
        const SAMPLE_INTERVENTIONS = [ { id: 'int_1', date: '2024-08-20', drugName: 'Apivar', batchNumber: 'L8833', quantity: '2 lani√®res', posology: 'Traitement fin de saison', apiaryId: 'api_1', hiveId: '' }, { id: 'int_2', date: '2024-12-15', drugName: 'Acide Oxalique', batchNumber: 'AO-22', quantity: '30ml', posology: 'D√©gouttement hors couvain', apiaryId: 'api_2', hiveId: '' } ];
        const SAMPLE_FEEDINGS = [ { id: 'feed_1', date: '2024-02-10', foodType: 'Candi', quantity: '1 pain 2.5kg', apiaryId: 'api_1', hiveId: '' }, { id: 'feed_2', date: '2024-09-01', foodType: 'Sirop 50/50', quantity: '3 Litres', apiaryId: 'api_2', hiveId: '' } ];
        const SAMPLE_HARVESTS = [ { id: 'har_1', date: '2024-05-20', apiaryId: 'api_2', honeyType: 'Printemps', quantityKg: 45, batchId: 'VRAC-2024-001' }, { id: 'har_2', date: '2024-07-15', apiaryId: 'api_1', honeyType: 'Toutes fleurs', quantityKg: 80, batchId: 'VRAC-2024-002' } ];
        const SAMPLE_PACKAGING = [ { id: 'pkg_1', date: '2024-06-01', harvestBatchIds: ['har_1'], quantityPots: 80, potSize: '500g', finalBatchNumber: '2024-PRI', ddm: '2026-06-01', honeyType: 'Printemps' }, { id: 'pkg_2', date: '2024-08-01', harvestBatchIds: ['har_2'], quantityPots: 70, potSize: '1kg', finalBatchNumber: '2024-ETF', ddm: '2026-08-01', honeyType: 'Toutes fleurs' } ];
        const SAMPLE_PRODUCTS = [ { id: 'prod_1', name: 'Miel de Printemps Cr√©meux', potSize: '500g', price: 7.50, currentBatchId: 'pkg_1' }, { id: 'prod_2', name: 'Miel Toutes Fleurs', potSize: '1kg', price: 14.00, currentBatchId: 'pkg_2' } ];
        const SAMPLE_CLIENTS = [ { id: 'cli_1', name: 'Mme Durand', phone: '0601020304', email: 'durand@email.com', address: 'Angers' }, { id: 'cli_2', name: '√âpicerie Du Coin', phone: '0241000000', address: 'Place du village' } ];
        const SAMPLE_SALES = [ { id: 'sale_1', date: '2024-06-15', finalBatchNumber: '2024-PRI', quantitySold: 2, buyerType: 'DIRECT', buyerName: 'Mme Durand', clientId: 'cli_1', paymentMethod: 'ESPECES', totalPrice: 15.00, productName: 'Miel de Printemps Cr√©meux', format: '500g' }, { id: 'sale_2', date: '2024-09-10', finalBatchNumber: '2024-ETF', quantitySold: 10, buyerType: 'WHOLESALE', buyerName: '√âpicerie Du Coin', clientId: 'cli_2', paymentMethod: 'VIREMENT', totalPrice: 140.00, productName: 'Miel Toutes Fleurs', format: '1kg' } ];
        const SAMPLE_EXPENSES = [ { id: 'exp_1', date: '2024-01-10', store: 'Icko', description: 'Cire Gauffr√©e', category: 'MATERIEL', amount: 150.00 }, { id: 'exp_2', date: '2024-03-05', store: 'Pharmacie', description: 'Acide Formique', category: 'SOIN', amount: 45.50 }, { id: 'exp_3', date: '2024-05-15', store: 'Verrerie de l\'Ouest', description: 'Pots 500g + Couvercles', category: 'CONDITIONNEMENT', amount: 200.00 } ];

        const get = (key, def) => { try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; } };
        const set = (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) { console.error("Quota Exceeded", e); } };

        const createListManager = (key, defaultList = []) => ({
            getAll: () => get(key, defaultList),
            add: (item) => { const l = get(key, defaultList); l.push(item); set(key, l); },
            update: (item) => { const l = get(key, defaultList); const i = l.findIndex(x=>x.id===item.id); if(i>=0)l[i]=item; set(key, l); },
            delete: (id) => set(key, get(key, defaultList).filter(x=>x.id!==id))
        });

        // Config par d√©faut
        const DEFAULT_HONEY_TYPES = ['Toutes fleurs', 'Acacia', 'Ch√¢taignier', 'Printemps', '√ât√©', 'For√™t', 'Lavande', 'Sapin'];
        const DEFAULT_FOOD_TYPES = ['Sirop 50/50', 'Sirop 70/30', 'Sirop de stimulation', 'Candi', 'Candi Prot√©in√©', 'Sucre'];

        // OBJET STORAGE GLOBAL
        const Storage = {
            generateId,
            getProfile: () => get(STORAGE_KEYS.PROFILE, SAMPLE_PROFILE),
            saveProfile: (p) => set(STORAGE_KEYS.PROFILE, p),
            
            getApiaries: () => get(STORAGE_KEYS.APIARIES, SAMPLE_APIARIES),
            saveApiary: (a) => { const l = get(STORAGE_KEYS.APIARIES, SAMPLE_APIARIES); const i = l.findIndex(x=>x.id===a.id); if(i>=0) l[i]=a; else l.push(a); set(STORAGE_KEYS.APIARIES, l); },
            deleteApiary: (id) => set(STORAGE_KEYS.APIARIES, get(STORAGE_KEYS.APIARIES, SAMPLE_APIARIES).filter(x=>x.id!==id)),
            
            hives: createListManager(STORAGE_KEYS.HIVES, SAMPLE_HIVES),
            movements: createListManager(STORAGE_KEYS.MOVEMENTS, SAMPLE_MOVEMENTS),
            interventions: createListManager(STORAGE_KEYS.INTERVENTIONS, SAMPLE_INTERVENTIONS),
            feedings: createListManager(STORAGE_KEYS.FEEDINGS, SAMPLE_FEEDINGS),
            harvests: createListManager(STORAGE_KEYS.HARVESTS, SAMPLE_HARVESTS),
            packaging: createListManager(STORAGE_KEYS.PACKAGING, SAMPLE_PACKAGING),
            sales: createListManager(STORAGE_KEYS.SALES, SAMPLE_SALES),
            products: createListManager(STORAGE_KEYS.PRODUCTS, SAMPLE_PRODUCTS),
            expenses: createListManager(STORAGE_KEYS.EXPENSES, SAMPLE_EXPENSES),
            clients: createListManager(STORAGE_KEYS.CLIENTS, SAMPLE_CLIENTS),
            
            getHoneyTypes: () => get(STORAGE_KEYS.HONEY_TYPES, DEFAULT_HONEY_TYPES),
            saveHoneyTypes: (t) => set(STORAGE_KEYS.HONEY_TYPES, t),
            getFoodTypes: () => get(STORAGE_KEYS.FOOD_TYPES, DEFAULT_FOOD_TYPES),
            saveFoodTypes: (t) => set(STORAGE_KEYS.FOOD_TYPES, t),
            getCostConfig: () => get(STORAGE_KEYS.COST_CONFIG, SAMPLE_COST_CONFIG),
            saveCostConfig: (c) => set(STORAGE_KEYS.COST_CONFIG, c),

            exportAllData: () => {
                const data = {};
                Object.keys(STORAGE_KEYS).forEach(k => data[k] = get(STORAGE_KEYS[k], []));
                return JSON.stringify({version:'1.20', timestamp: new Date().toISOString(), data});
            },
            importAllData: (json) => {
                try {
                    const parsed = JSON.parse(json);
                    if(!parsed.data) return false;
                    Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key)); // Nettoyer avant import
                    Object.keys(parsed.data).forEach(k => {
                        const foundKey = Object.keys(STORAGE_KEYS).find(sk => sk === k || STORAGE_KEYS[sk] === k);
                        if(foundKey) set(STORAGE_KEYS[foundKey], parsed.data[k]);
                    });
                    return true;
                } catch(e) { return false; }
            }
        };

        // --- 2. SERVICE PDF INTEGR√â ---
        const PDFService = {
            generateDoc: (title, start, end) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const profile = Storage.getProfile();
                
                doc.setFontSize(18);
                doc.setTextColor(42, 51, 30);
                doc.text(profile.companyName || "Apiculture", 14, 20);
                doc.setFontSize(10);
                doc.setTextColor(100);
                let y = 26;
                doc.text(profile.address || '', 14, y);
                if(profile.address) y+=6;
                doc.text(`NAPI: ${profile.napi} | SIRET: ${profile.siret} | Statut: ${profile.status}`, 14, y);
                y+=6;
                doc.text(`V√©t√©rinaire: ${profile.vetName} - ${profile.vetAddress}`, 14, y);
                doc.setDrawColor(200);
                doc.line(14, y+4, 196, y+4);
                doc.setFontSize(14);
                doc.setTextColor(0);
                const sStr = new Date(start).toLocaleDateString('fr-FR');
                const eStr = new Date(end).toLocaleDateString('fr-FR');
                doc.text(`${title} (${sStr} - ${eStr})`, 14, y+14);
                return {doc, y: y+20};
            },
            
            filterByDate: (items, start, end) => items.filter(i => i.date >= start && i.date <= end),

            generateBreedingRegisterPDF: (s, e) => {
                const {doc, y} = PDFService.generateDoc("Registre d'√âlevage", s, e);
                const filter = (arr) => PDFService.filterByDate(arr, s, e);
                const apiaries = Storage.getApiaries();
                const hives = Storage.hives.getAll();
                const getTarget = (aid, hid) => {
                    const aname = apiaries.find(a=>a.id===aid)?.name || 'Inconnu';
                    const hname = hid ? hives.find(h=>h.id===hid)?.name : null;
                    return hname ? `${aname} > ${hname}` : aname;
                };

                doc.setFontSize(12); doc.text("1. Traitements", 14, y);
                doc.autoTable({
                    startY: y+5, head: [['Date', 'Rucher/Ruche', 'M√©dicament', 'N¬∞ Lot', 'Qt√©', 'Posologie']],
                    body: filter(Storage.interventions.getAll()).map(i => [new Date(i.date).toLocaleDateString(), getTarget(i.apiaryId, i.hiveId), i.drugName, i.batchNumber, i.quantity, i.posology]),
                    theme:'grid', headStyles:{fillColor:[220, 38, 38]}
                });
                
                let fy = doc.lastAutoTable.finalY + 15;
                doc.text("2. Mouvements", 14, fy);
                doc.autoTable({
                    startY: fy+5, head: [['Date', 'Type', 'Origine > Dest.', 'Qt√©', 'Note']],
                    body: filter(Storage.movements.getAll()).map(m => [new Date(m.date).toLocaleDateString(), m.type, `${apiaries.find(a=>a.id===m.originApiaryId)?.name||'-'} > ${apiaries.find(a=>a.id===m.destinationApiaryId)?.name||'-'}`, m.quantity, m.description]),
                    theme:'grid', headStyles:{fillColor:[37, 99, 235]}
                });

                fy = doc.lastAutoTable.finalY + 15;
                if(fy > 250) { doc.addPage(); fy=20; }
                doc.text("3. Nourrissement", 14, fy);
                doc.autoTable({
                    startY: fy+5, head: [['Date', 'Rucher', 'Type', 'Qt√©']],
                    body: filter(Storage.feedings.getAll()).map(f => [new Date(f.date).toLocaleDateString(), getTarget(f.apiaryId, f.hiveId), f.foodType, f.quantity]),
                    theme:'grid', headStyles:{fillColor:[202, 138, 4]}
                });
                doc.save('registre_elevage.pdf');
            },
            
            generateHoneyTraceabilityPDF: (s, e) => {
                const {doc, y} = PDFService.generateDoc("Cahier de Miellerie", s, e);
                const filter = (arr) => PDFService.filterByDate(arr, s, e);
                const apiaries = Storage.getApiaries();

                doc.setFontSize(12); doc.text("1. R√©coltes (Vrac)", 14, y);
                doc.autoTable({
                    startY: y+5, head: [['Date', 'Rucher', 'Miel', 'Poids', 'Lot Vrac']],
                    body: filter(Storage.harvests.getAll()).map(h => [new Date(h.date).toLocaleDateString(), apiaries.find(a=>a.id===h.apiaryId)?.name||'Inconnu', h.honeyType, h.quantityKg+'kg', h.batchId]),
                    theme:'grid', headStyles:{fillColor:[217, 119, 6]}
                });
                
                let fy = doc.lastAutoTable.finalY + 15;
                doc.text("2. Conditionnement", 14, fy);
                doc.autoTable({
                    startY: fy+5, head: [['Date', 'Lot √âtiquette', 'Conditionnement']],
                    body: filter(Storage.packaging.getAll()).map(p => [new Date(p.date).toLocaleDateString(), p.finalBatchNumber, `${p.quantityPots} x ${p.potSize}`]),
                    theme:'grid', headStyles:{fillColor:[217, 119, 6]}
                });
                doc.save('miellerie.pdf');
            },

            generateSalesPDF: (s, e) => {
                const {doc, y} = PDFService.generateDoc("Livre de Recettes", s, e);
                const sales = PDFService.filterByDate(Storage.sales.getAll(), s, e).sort((a,b)=>new Date(a.date)-new Date(b.date));
                
                doc.autoTable({ 
                    startY: y, head: [['Date', 'Client', 'Produit', 'Qt√©', 'Fmt', 'Paiement', 'Total']], 
                    body: sales.map(x => [new Date(x.date).toLocaleDateString(), x.buyerName||'Direct', x.productName||x.finalBatchNumber, x.quantitySold, x.format||'-', x.paymentMethod, x.totalPrice.toFixed(2)+'‚Ç¨']), 
                    theme:'grid', headStyles:{fillColor:[22, 163, 74]},
                    foot: [['', '', '', '', '', 'TOTAL', sales.reduce((a,b)=>a+(b.totalPrice||0),0).toFixed(2)+'‚Ç¨']]
                });
                doc.save('ventes.pdf');
            }
        };

        // --- 3. COMPOSANTS PARTAG√âS ---
        
        const HiveIcon = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <rect x="3" y="3" width="18" height="4" rx="1" />
                <rect x="5" y="7" width="14" height="11" />
                <path d="M9 14h6" />
                <path d="M6 18v3" />
                <path d="M18 18v3" />
            </svg>
        );

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 animate-in fade-in zoom-in duration-200">
                        <div className="flex items-center gap-3 text-red-600 mb-4">
                            <AlertTriangle size={28} />
                            <h3 className="text-xl font-bold">{title}</h3>
                        </div>
                        <p className="text-gray-600 mb-6">{message}</p>
                        <div className="flex gap-3 justify-end">
                            <button onClick={onCancel} className="px-4 py-2 text-gray-600 font-medium hover:bg-gray-100 rounded-lg">Annuler</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 shadow-sm">Confirmer</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SimpleDonutChart = ({ data }) => {
            const total = data.reduce((sum, item) => sum + item.value, 0);
            if (total === 0) return <div className="h-40 flex items-center justify-center text-gray-400 text-xs">Pas de donn√©es</div>;
            let currentAngle = 0;
            const gradientParts = data.map(item => {
                const percentage = (item.value / total) * 100;
                const start = currentAngle;
                const end = currentAngle + percentage;
                currentAngle = end;
                return `${item.color} ${start}% ${end}%`;
            });
            return (
                <div className="flex flex-col items-center justify-center">
                    <div className="relative w-32 h-32 rounded-full mb-4 shadow-sm" style={{ background: `conic-gradient(${gradientParts.join(', ')})` }}>
                        <div className="absolute inset-4 bg-white rounded-full flex items-center justify-center flex-col">
                            <span className="text-xs text-gray-400">Total</span>
                            <span className="font-bold text-gray-800">{total.toFixed(0)}‚Ç¨</span>
                        </div>
                    </div>
                    <div className="w-full space-y-1">
                        {data.map((item, idx) => (
                            <div key={idx} className="flex justify-between text-xs items-center">
                                <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full" style={{ background: item.color }}></span><span className="text-gray-600">{item.name}</span></div>
                                <span className="font-bold">{item.value.toFixed(0)} ‚Ç¨</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SimpleBarChart = ({ data }) => {
            const max = Math.max(...data.map(d => d.value), 1);
            if(data.length === 0) return <div className="h-40 flex items-center justify-center text-gray-400 text-xs">Pas de donn√©es</div>;
            return (
                <div className="space-y-3 w-full">
                    {data.map((item, idx) => (
                        <div key={idx} className="w-full">
                            <div className="flex justify-between text-xs mb-1"><span className="font-medium text-gray-700">{item.name}</span><span className="font-bold text-honey-600">{item.value.toFixed(0)} ‚Ç¨</span></div>
                            <div className="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden"><div className="bg-honey-500 h-2.5 rounded-full" style={{ width: `${(item.value / max) * 100}%` }}></div></div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- 4. MODULES METIERS ---

        // >>> CLIENTS <<<
        const ClientManager = () => {
            const [clients, setClients] = useState([]);
            const [sales, setSales] = useState([]);
            const [formData, setFormData] = useState({ name: '', phone: '', email: '', address: '' });
            const [editingId, setEditingId] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            useEffect(() => refreshData(), []);
            const refreshData = () => { setClients(Storage.clients.getAll()); setSales(Storage.sales.getAll()); };
            
            const handleSaveClient = () => {
                if (!formData.name) return;
                const id = editingId || Storage.generateId();
                if(editingId) Storage.clients.update({ ...formData, id }); else Storage.clients.add({ ...formData, id });
                setFormData({ name: '', phone: '', email: '', address: '' }); setEditingId(null); refreshData();
            };
            
            const sortedClients = clients.map(c => ({
                ...c, 
                totalSpent: sales.filter(s => s.clientId === c.id || s.buyerName === c.name).reduce((sum, s) => sum + (s.totalPrice || 0), 0)
            })).sort((a,b) => b.totalSpent - a.totalSpent).filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 rounded-xl text-white shadow-md">
                        <h2 className="text-2xl font-bold flex items-center gap-2"><Users /> Gestion des Clients</h2>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 md:col-span-1 h-fit">
                            <h3 className="font-bold text-gray-800 mb-4">{editingId ? "Modifier" : "Nouveau"}</h3>
                            <input type="text" placeholder="Nom *" className="w-full border p-2 rounded mb-2" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})}/>
                            <input type="text" placeholder="Tel" className="w-full border p-2 rounded mb-2" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})}/>
                            <input type="text" placeholder="Email" className="w-full border p-2 rounded mb-2" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})}/>
                            <input type="text" placeholder="Adresse" className="w-full border p-2 rounded mb-2" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})}/>
                            <button onClick={handleSaveClient} className="w-full bg-blue-600 text-white p-2 rounded font-bold">{editingId?'Mettre √† jour':'Enregistrer'}</button>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm md:col-span-2">
                            <input type="text" placeholder="Rechercher..." className="w-full border p-2 rounded mb-4" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/>
                            <div className="space-y-2 max-h-[400px] overflow-y-auto">
                                {sortedClients.map(client => (
                                    <div key={client.id} className="flex justify-between p-3 border rounded items-center bg-gray-50">
                                        <div>
                                            <div className="font-bold">{client.name}</div>
                                            <div className="text-xs text-gray-500">{client.phone} | Achat: {client.totalSpent.toFixed(2)}‚Ç¨</div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={()=>{setEditingId(client.id); setFormData(client);}} className="text-blue-500"><Edit2 size={16}/></button>
                                            <button onClick={()=>{if(confirm('Supprimer?')) {Storage.clients.delete(client.id); refreshData();}}} className="text-red-500"><Trash2 size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // >>> DEPENSES <<<
        const Expenses = () => {
            const [expenses, setExpenses] = useState([]);
            const [newExpense, setNewExpense] = useState({ date: new Date().toISOString().split('T')[0], store: '', description: '', category: 'MATERIEL', amount: '' });
            useEffect(() => setExpenses(Storage.expenses.getAll().sort((a,b)=>new Date(b.date)-new Date(a.date))), []);
            
            const handleAdd = () => {
                if(!newExpense.amount) return;
                Storage.expenses.add({ ...newExpense, id: Storage.generateId(), amount: parseFloat(newExpense.amount) });
                setNewExpense({ ...newExpense, description: '', amount: '' });
                setExpenses(Storage.expenses.getAll().sort((a,b)=>new Date(b.date)-new Date(a.date)));
            };

            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-red-600 to-red-500 p-6 rounded-xl text-white shadow-md">
                        <h2 className="text-2xl font-bold flex items-center gap-2"><Wallet /> D√©penses</h2>
                        <div className="mt-2 text-3xl font-bold">{expenses.reduce((a,b)=>a+b.amount,0).toFixed(2)} ‚Ç¨</div>
                    </div>
                    <div className="bg-white p-6 rounded-xl border border-gray-100">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-2">
                            <input type="date" className="border p-2 rounded" value={newExpense.date} onChange={e=>setNewExpense({...newExpense, date: e.target.value})}/>
                            <input type="text" placeholder="Magasin" className="border p-2 rounded" value={newExpense.store} onChange={e=>setNewExpense({...newExpense, store: e.target.value})}/>
                            <input type="text" placeholder="Article" className="border p-2 rounded" value={newExpense.description} onChange={e=>setNewExpense({...newExpense, description: e.target.value})}/>
                            <input type="number" placeholder="Montant" className="border p-2 rounded" value={newExpense.amount} onChange={e=>setNewExpense({...newExpense, amount: e.target.value})}/>
                        </div>
                        <button onClick={handleAdd} className="mt-2 w-full bg-red-600 text-white p-2 rounded font-bold">Ajouter D√©pense</button>
                    </div>
                    <div className="space-y-2 max-h-[400px] overflow-y-auto">
                        {expenses.map(exp => (
                            <div key={exp.id} className="flex justify-between p-3 bg-white border rounded items-center">
                                <div><div className="font-bold">{exp.store}</div><div className="text-xs text-gray-500">{exp.description} ({new Date(exp.date).toLocaleDateString()})</div></div>
                                <div className="font-bold text-red-600">-{exp.amount.toFixed(2)}‚Ç¨</div>
                                <button onClick={()=>{Storage.expenses.delete(exp.id); setExpenses(Storage.expenses.getAll().sort((a,b)=>new Date(b.date)-new Date(a.date)));}} className="ml-2 text-gray-300 hover:text-red-500"><Trash2 size={16}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // >>> ELEVAGE <<<
        const BreedingRegister = () => {
            const [activeTab, setActiveTab] = useState('APIARY');
            const [apiaries, setApiaries] = useState([]);
            const [hives, setHives] = useState([]);
            const [interventions, setInterventions] = useState([]);
            const [feedings, setFeedings] = useState([]);
            const [movements, setMovements] = useState([]);
            
            const [newInt, setNewInt] = useState({date: new Date().toISOString().split('T')[0], drugName: '', batchNumber: '', quantity: '', apiaryId: ''});
            const [newFeeding, setNewFeeding] = useState({date: new Date().toISOString().split('T')[0], foodType:'', quantity:'', apiaryId:''});
            const [newMov, setNewMov] = useState({date: new Date().toISOString().split('T')[0], type:'Transhumance', description:'', originApiaryId:'', destinationApiaryId:'', quantity:1});

            useEffect(() => { refresh(); }, []);
            const refresh = () => { 
                setApiaries(Storage.getApiaries()); 
                setHives(Storage.hives.getAll()); 
                setInterventions(Storage.interventions.getAll());
                setFeedings(Storage.feedings.getAll());
                setMovements(Storage.movements.getAll());
            };

            return (
                <div className="space-y-6">
                    <div className="flex gap-2 mb-4 overflow-x-auto no-scrollbar">
                        {[{id:'APIARY',label:'Ruchers',icon:MapPin}, {id:'SANITARY',label:'Soins',icon:Syringe}, {id:'FEEDING',label:'Nourrissement',icon:Utensils}, {id:'MOVEMENTS',label:'Mouvements',icon:Truck}].map(t => (
                            <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`flex items-center gap-2 px-4 py-2 rounded-full font-bold border whitespace-nowrap ${activeTab===t.id?'bg-honey-600 text-white':'bg-white'}`}>
                                <t.icon size={16}/> {t.label}
                            </button>
                        ))}
                    </div>
                    {activeTab === 'APIARY' && (
                        <div className="space-y-2">
                            {apiaries.map(apiary => (
                                <div key={apiary.id} className="bg-white border rounded-xl p-4">
                                    <h3 className="font-bold text-lg">{apiary.name}</h3>
                                    <p className="text-gray-500 text-xs mb-2">{apiary.location}</p>
                                    <div className="flex flex-wrap gap-2">
                                        {hives.filter(h=>h.apiaryId===apiary.id).map(hive => (
                                            <span key={hive.id} className="px-2 py-1 bg-honey-50 border border-honey-100 rounded text-xs font-bold text-honey-700 flex items-center gap-1">
                                                <HiveIcon size={12}/> {hive.name}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    {activeTab === 'SANITARY' && (
                        <div>
                             <div className="bg-white p-4 rounded-xl border mb-4 shadow-sm">
                                 <h3 className="font-bold mb-2">Nouveau Traitement</h3>
                                 <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    <input type="date" className="border p-2 rounded" value={newInt.date} onChange={e=>setNewInt({...newInt, date:e.target.value})}/>
                                    <select className="border p-2 rounded" value={newInt.apiaryId} onChange={e=>setNewInt({...newInt, apiaryId:e.target.value})}>
                                        <option value="">Rucher...</option>
                                        {apiaries.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}
                                    </select>
                                    <input type="text" placeholder="M√©dicament" className="border p-2 rounded" value={newInt.drugName} onChange={e=>setNewInt({...newInt, drugName:e.target.value})}/>
                                    <input type="text" placeholder="N¬∞ Lot" className="border p-2 rounded" value={newInt.batchNumber} onChange={e=>setNewInt({...newInt, batchNumber:e.target.value})}/>
                                 </div>
                                 <button onClick={()=>{if(newInt.drugName){Storage.interventions.add({...newInt, id:Storage.generateId()}); refresh();}}} className="w-full bg-red-600 text-white p-2 rounded font-bold mt-2">Enregistrer</button>
                             </div>
                             <div className="space-y-2">
                                 {interventions.map(i => (<div key={i.id} className="p-3 bg-white border rounded shadow-sm"><div className="font-bold">{i.drugName}</div><div className="text-xs text-gray-500">Lot: {i.batchNumber} | {new Date(i.date).toLocaleDateString()}</div><button onClick={()=>{Storage.interventions.delete(i.id); refresh();}} className="text-red-500 text-xs">Supprimer</button></div>))}
                             </div>
                        </div>
                    )}
                    {activeTab === 'FEEDING' && (
                        <div>
                             <div className="bg-white p-4 rounded-xl border mb-4">
                                 <h3 className="font-bold mb-2">Nourrissement</h3>
                                 <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    <input type="date" className="border p-2 rounded" value={newFeeding.date} onChange={e=>setNewFeeding({...newFeeding, date:e.target.value})}/>
                                    <select className="border p-2 rounded" value={newFeeding.apiaryId} onChange={e=>setNewFeeding({...newFeeding, apiaryId:e.target.value})}>
                                        <option value="">Rucher...</option>
                                        {apiaries.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}
                                    </select>
                                    <input type="text" placeholder="Type" className="border p-2 rounded" value={newFeeding.foodType} onChange={e=>setNewFeeding({...newFeeding, foodType:e.target.value})}/>
                                    <input type="text" placeholder="Quantit√©" className="border p-2 rounded" value={newFeeding.quantity} onChange={e=>setNewFeeding({...newFeeding, quantity:e.target.value})}/>
                                 </div>
                                 <button onClick={()=>{if(newFeeding.foodType){Storage.feedings.add({...newFeeding, id:Storage.generateId()}); refresh();}}} className="w-full bg-amber-500 text-white p-2 rounded font-bold mt-2">Enregistrer</button>
                             </div>
                             <div className="space-y-2">
                                 {feedings.map(f => (<div key={f.id} className="p-3 bg-white border rounded"><div className="font-bold">{f.foodType} - {f.quantity}</div><div className="text-xs text-gray-500">{new Date(f.date).toLocaleDateString()}</div></div>))}
                             </div>
                        </div>
                    )}
                    {activeTab === 'MOVEMENTS' && (
                       <div>
                         <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Truck className="text-honey-600" /> Mouvements</h2>
                         <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4">
                           <input type="date" className="border p-2 rounded w-full mb-2" value={newMov.date} onChange={e => setNewMov({ ...newMov, date: e.target.value })} />
                           <input type="text" placeholder="Description" className="border p-2 rounded w-full mb-2" value={newMov.description} onChange={e => setNewMov({ ...newMov, description: e.target.value })} />
                           <div className="flex gap-2 mb-2">
                               <select className="border p-2 rounded w-full" value={newMov.originApiaryId} onChange={e => setNewMov({ ...newMov, originApiaryId: e.target.value })}><option value="">D√©part</option>{apiaries.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select>
                               <select className="border p-2 rounded w-full" value={newMov.destinationApiaryId} onChange={e => setNewMov({ ...newMov, destinationApiaryId: e.target.value })}><option value="">Arriv√©e</option>{apiaries.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}</select>
                           </div>
                           <button onClick={()=>{if(newMov.description){Storage.movements.add({...newMov, id:Storage.generateId()}); refresh();}}} className="bg-blue-600 text-white p-2 rounded w-full font-bold">Enregistrer</button>
                        </div>
                        <div className="space-y-2">
                            {movements.map(m => (<div key={m.id} className="p-3 border-b bg-white rounded"><span className="font-bold text-blue-800">{m.type}</span>: {m.description} ({m.quantity} ruches) <button onClick={() => { Storage.movements.delete(m.id); refresh(); }} className="text-red-400 float-right"><Trash2 size={16} /></button></div>))}
                        </div>
                       </div>
                    )}
                </div>
            );
        };

        // >>> MIELLERIE & CAISSE (Logic Integrated from HoneyTraceability) <<<
        const HoneyTraceability = ({ initialTab }) => {
            const [activeTab, setActiveTab] = useState(initialTab || 'POS');
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);
            const [packagings, setPackagings] = useState([]);
            const [harvests, setHarvests] = useState([]);
            const [animatingItems, setAnimatingItems] = useState([]);
            const [newPackage, setNewPackage] = useState({date:new Date().toISOString().split('T')[0], finalBatchNumber:'', quantityPots:0, potSize:'500g', honeyType:''});
            const [newHarvest, setNewHarvest] = useState({date:new Date().toISOString().split('T')[0], honeyType:'', quantityKg:0});

            useEffect(() => { 
                setProducts(Storage.products.getAll()); 
                setPackagings(Storage.packaging.getAll());
                setHarvests(Storage.harvests.getAll());
                setActiveTab(initialTab || 'POS'); 
            }, [initialTab]);

            const addToCart = (p) => {
                const key = Date.now();
                setAnimatingItems(prev => [...prev, {id: p.id, key}]);
                setTimeout(() => setAnimatingItems(prev => prev.filter(i => i.key !== key)), 800);
                setCart(prev => {
                    const ex = prev.find(x => x.product.id === p.id);
                    if(ex) return prev.map(x => x.product.id === p.id ? {...x, quantity: x.quantity+1} : x);
                    return [...prev, {product: p, quantity: 1}];
                });
            };

            const handleCheckout = () => {
                const total = cart.reduce((a,b)=>a+(b.quantity*b.product.price),0);
                cart.forEach(item => {
                    Storage.sales.add({
                        id: Storage.generateId(),
                        date: new Date().toISOString().split('T')[0],
                        productName: item.product.name,
                        quantitySold: item.quantity,
                        totalPrice: item.quantity * item.product.price,
                        paymentMethod: 'ESPECES',
                        finalBatchNumber: item.product.currentBatchId ? Storage.packaging.getAll().find(p=>p.id===item.product.currentBatchId)?.finalBatchNumber : 'VRAC'
                    });
                });
                setCart([]);
                alert(`Vente de ${total.toFixed(2)}‚Ç¨ enregistr√©e !`);
            };

            return (
                <div className="h-full">
                     <div className="flex gap-2 mb-6 overflow-x-auto pb-2 no-scrollbar">
                        {[{id:'POS', label:'Caisse', icon:ShoppingCart}, {id:'PRODUCTS', label:'Produits', icon:Store}, {id:'PACKAGING', label:'Mise en pot', icon:Package}, {id:'HARVEST', label:'R√©colte', icon:Archive}].map(t => (
                            <button key={t.id} onClick={() => setActiveTab(t.id)} className={`flex items-center gap-2 px-5 py-2 rounded-full text-sm font-bold tracking-wide transition shadow-sm ${activeTab===t.id ? 'bg-rucher-yellow text-rucher-dark' : 'bg-white text-gray-500 border border-gray-200'}`}>
                                <t.icon size={16}/> {t.label}
                            </button>
                        ))}
                     </div>

                     {activeTab === 'POS' && (
                         <div className="flex flex-col md:flex-row gap-6 h-full">
                             <div className="flex-1">
                                 <h2 className="font-serif text-2xl mb-4 text-rucher-dark">Catalogue</h2>
                                 <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                     {products.map(p => (
                                         <button key={p.id} onClick={() => addToCart(p)} className="relative bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:border-rucher-yellow hover:shadow-md transition text-left group overflow-visible select-none">
                                             {animatingItems.filter(i => i.id === p.id).map(anim => (
                                                <div key={anim.key} className="absolute inset-0 flex items-center justify-center pointer-events-none z-50 animate-fly-cart"><div className="text-4xl filter drop-shadow-lg transform -scale-x-100">üêù</div></div>
                                             ))}
                                             <div className="h-24 bg-rucher-bg rounded mb-3 flex items-center justify-center relative overflow-hidden">
                                                 {p.imageUrl ? <img src={p.imageUrl} className="w-full h-full object-cover"/> : <Store size={32} className="text-rucher-green opacity-30"/>}
                                                 <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition text-rucher-yellow"><Plus size={20}/></div>
                                             </div>
                                             <div className="font-bold text-rucher-dark truncate">{p.name}</div>
                                             <div className="text-rucher-green font-bold mt-1">{p.price.toFixed(2)} ‚Ç¨</div>
                                             <div className="text-xs text-gray-400">{p.potSize}</div>
                                         </button>
                                     ))}
                                     {products.length === 0 && <div className="col-span-full text-center py-10 text-gray-400 font-serif italic">Aucun produit. Allez dans "Produits" pour en cr√©er.</div>}
                                 </div>
                             </div>
                             
                             <div className="w-full md:w-80 bg-white shadow-xl border border-gray-100 rounded-xl p-5 flex flex-col h-fit sticky top-4">
                                 <h3 className="font-serif text-xl border-b border-rucher-yellow pb-3 mb-3 flex justify-between items-center text-rucher-dark">
                                     <span>Panier</span>
                                     <span className="bg-rucher-yellow text-rucher-dark px-2 py-1 rounded-full text-xs font-bold">{cart.reduce((a,b)=>a+b.quantity,0)}</span>
                                 </h3>
                                 <div className="flex-1 overflow-y-auto space-y-3 min-h-[200px]">
                                     {cart.map((item, idx) => (
                                         <div key={idx} className="flex justify-between text-sm items-center border-b border-dashed border-gray-100 pb-2">
                                             <div><div className="font-bold text-gray-800">{item.product.name}</div><div className="text-xs text-gray-500">x{item.quantity}</div></div>
                                             <div className="font-bold text-rucher-green">{(item.quantity * item.product.price).toFixed(2)}‚Ç¨</div>
                                         </div>
                                     ))}
                                     {cart.length === 0 && <div className="text-gray-400 italic text-center mt-10">Panier vide</div>}
                                 </div>
                                 <div className="border-t border-gray-200 pt-4 mt-2">
                                     <div className="flex justify-between font-serif text-2xl mb-4 text-rucher-dark"><span>Total</span><span>{cart.reduce((a,b)=>a+(b.quantity*b.product.price),0).toFixed(2)} ‚Ç¨</span></div>
                                     <button onClick={handleCheckout} disabled={cart.length===0} className="w-full bg-rucher-green text-white py-3 rounded shadow-md font-bold hover:bg-rucher-dark transition disabled:opacity-50">Encaisser</button>
                                 </div>
                             </div>
                         </div>
                     )}
                     
                     {activeTab === 'PRODUCTS' && (
                         <div className="bg-white p-6 rounded-xl shadow-sm">
                             <h2 className="font-serif text-2xl mb-4">Produits</h2>
                             <div className="flex flex-col gap-2 mb-4">
                                 <input id="newProdName" placeholder="Nom (ex: Miel Acacia)" className="border p-2 rounded"/>
                                 <div className="flex gap-2">
                                    <input id="newProdPrice" placeholder="Prix" type="number" className="border p-2 rounded w-24"/>
                                    <input type="file" id="prodImg" className="hidden" onChange={(e)=>{
                                        if(e.target.files[0]) compressImage(e.target.files[0]).then(res => document.getElementById('preview').src = res);
                                    }}/>
                                    <label htmlFor="prodImg" className="border p-2 rounded cursor-pointer flex items-center gap-2"><ImagePlus size={18}/> Photo</label>
                                    <img id="preview" className="h-10 w-10 object-cover rounded bg-gray-100"/>
                                 </div>
                                 <button onClick={() => {
                                     const name = document.getElementById('newProdName').value;
                                     const price = parseFloat(document.getElementById('newProdPrice').value);
                                     const img = document.getElementById('preview').src;
                                     if(name && price) {
                                         Storage.products.add({id:Storage.generateId(), name, price, potSize:'500g', imageUrl: img.startsWith('data') ? img : null});
                                         setProducts(Storage.products.getAll());
                                     }
                                 }} className="bg-rucher-yellow px-4 py-2 rounded font-bold text-rucher-dark">Ajouter</button>
                             </div>
                             <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                 {products.map(p => (
                                    <div key={p.id} className="p-2 border rounded flex gap-2 items-center">
                                        <div className="h-12 w-12 bg-gray-100 rounded overflow-hidden">
                                            {p.imageUrl && <img src={p.imageUrl} className="h-full w-full object-cover"/>}
                                        </div>
                                        <div>
                                            <div className="font-bold">{p.name}</div>
                                            <div className="text-xs">{p.price}‚Ç¨</div>
                                        </div>
                                        <button onClick={()=>{Storage.products.delete(p.id); setProducts(Storage.products.getAll());}} className="ml-auto text-red-400"><Trash2/></button>
                                    </div>
                                ))}
                             </div>
                         </div>
                     )}

                     {activeTab === 'PACKAGING' && (
                        <div className="bg-white p-6 rounded-xl shadow-sm">
                            <h2 className="font-serif text-2xl mb-4">Mise en Pot (Lots)</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 bg-amber-50 p-4 rounded-xl">
                                <input className="border p-2 rounded" placeholder="Num√©ro de Lot (ex: 2025-01-AC)" value={newPackage.finalBatchNumber} onChange={e=>setNewPackage({...newPackage, finalBatchNumber:e.target.value})}/>
                                <input className="border p-2 rounded" type="number" placeholder="Quantit√© de pots" value={newPackage.quantityPots} onChange={e=>setNewPackage({...newPackage, quantityPots:e.target.value})}/>
                                <select className="border p-2 rounded bg-white" value={newPackage.potSize} onChange={e=>setNewPackage({...newPackage, potSize:e.target.value})}>
                                    {['250g','500g','1kg'].map(s=><option key={s} value={s}>{s}</option>)}
                                </select>
                                <button onClick={()=>{
                                    if(newPackage.finalBatchNumber && newPackage.quantityPots) {
                                        Storage.packaging.add({...newPackage, id:Storage.generateId()});
                                        setPackagings(Storage.packaging.getAll());
                                        alert('Lot cr√©√©');
                                    }
                                }} className="w-full bg-amber-500 text-white p-2 rounded font-bold md:col-span-2">Enregistrer</button>
                            </div>
                            <div className="space-y-2">
                                {packagings.map(p => <div key={p.id} className="text-sm p-3 bg-white border rounded flex justify-between"><span>Lot: <b>{p.finalBatchNumber}</b></span><span>{p.quantityPots} x {p.potSize}</span></div>)}
                            </div>
                        </div>
                     )}

                     {activeTab === 'HARVEST' && (
                         <div className="bg-white p-6 rounded-xl shadow-sm">
                             <h2 className="font-serif text-2xl mb-4">R√©coltes (Vrac)</h2>
                             <div className="flex gap-2 mb-4">
                                 <input className="border p-2 rounded flex-1" placeholder="Type Miel (ex: Acacia)" value={newHarvest.honeyType} onChange={e=>setNewHarvest({...newHarvest, honeyType:e.target.value})}/>
                                 <input className="border p-2 rounded w-24" type="number" placeholder="Kg" value={newHarvest.quantityKg} onChange={e=>setNewHarvest({...newHarvest, quantityKg:e.target.value})}/>
                                 <button onClick={()=>{
                                     if(newHarvest.honeyType && newHarvest.quantityKg){
                                         Storage.harvests.add({...newHarvest, id:Storage.generateId(), batchId:'VRAC-'+Date.now()});
                                         setHarvests(Storage.harvests.getAll());
                                     }
                                 }} className="bg-amber-600 text-white px-4 rounded font-bold">Ajouter</button>
                             </div>
                             {harvests.map(h => (
                                 <div key={h.id} className="p-3 border-b flex justify-between">
                                     <span>{h.honeyType}</span>
                                     <span className="font-bold">{h.quantityKg} kg</span>
                                 </div>
                             ))}
                         </div>
                     )}
                </div>
            );
        };

        // --- 5. APPLICATION PRINCIPALE ---
        const App = () => {
            const [view, setView] = useState('DASHBOARD');
            const [honeyTab, setHoneyTab] = useState('POS');
            const [profile, setProfile] = useState({});
            const [dashboardData, setDashboardData] = useState({totalSalesYear:0, totalExpensesYear:0});

            useEffect(() => {
                setProfile(Storage.getProfile());
                const sales = Storage.sales.getAll();
                const expenses = Storage.expenses.getAll();
                const totalSales = sales.reduce((sum, s) => sum + (s.totalPrice || 0), 0);
                const totalExp = expenses.reduce((sum, e) => sum + e.amount, 0);
                setDashboardData({totalSalesYear: totalSales, totalExpensesYear: totalExp});
            }, [view]);

            const NavItem = ({id, label, icon: Icon}) => (
                <button onClick={() => setView(id)} className={`flex flex-col md:flex-row items-center justify-center md:justify-start p-3 md:px-6 rounded-lg transition-all mb-1 ${view===id ? 'bg-rucher-yellow text-rucher-dark font-bold shadow-sm' : 'text-gray-400 hover:text-rucher-green hover:bg-rucher-bg'}`}>
                    <Icon size={22} className="mb-1 md:mb-0 md:mr-3" />
                    <span className="text-xs md:text-sm uppercase tracking-wide">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen flex flex-col md:flex-row font-sans text-gray-800">
                    <nav className="fixed bottom-0 left-0 w-full bg-white border-t border-rucher-yellow z-50 md:relative md:w-64 md:h-screen md:border-t-0 md:border-r md:flex md:flex-col p-4 shadow-2xl md:shadow-none safe-area-bottom">
                        <div className="hidden md:flex flex-col items-center mb-10 pt-4">
                            <div className="w-24 h-24 rounded-full border-4 border-rucher-yellow flex items-center justify-center bg-white shadow-md mb-3">
                                <span className="font-serif font-bold text-2xl text-rucher-dark">AG</span>
                            </div>
                            <h1 className="font-serif text-lg font-bold text-rucher-dark text-center leading-tight">Le Rucher Du<br/>Vieux Juign√©</h1>
                        </div>
                        <div className="flex justify-between md:flex-col md:gap-2 px-2 md:px-0">
                            <NavItem id="DASHBOARD" label="Accueil" icon={LayoutDashboard} />
                            <NavItem id="BREEDING" label="Ruchers" icon={HiveIcon} />
                            <NavItem id="HONEY" label="Miellerie" icon={Store} />
                            <NavItem id="EXPENSES" label="D√©penses" icon={Wallet} />
                            <NavItem id="CLIENTS" label="Clients" icon={Users} />
                            <NavItem id="SETTINGS" label="R√©glages" icon={Settings} />
                        </div>
                    </nav>

                    <main className="flex-1 pb-24 md:pb-8 p-4 md:p-8 overflow-y-auto h-screen relative bg-gray-50">
                        <div className="max-w-6xl mx-auto">
                            {/* HEADER MOBILE */}
                            <div className="md:hidden flex items-center justify-between mb-6 pb-4 border-b border-rucher-yellow">
                                <span className="font-serif font-bold text-rucher-dark text-lg">ApiGest</span>
                            </div>

                            {view === 'DASHBOARD' && (
                                <div className="space-y-8 animate-in fade-in duration-500">
                                    <header className="text-center md:text-left">
                                        <h1 className="font-serif text-3xl md:text-4xl text-rucher-dark mb-2">Bienvenue</h1>
                                        <p className="text-rucher-green font-light italic">{profile.companyName}</p>
                                    </header>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div onClick={() => { setView('HONEY'); setHoneyTab('POS'); }} className="bg-rucher-green text-white p-6 rounded-xl shadow-lg cursor-pointer transform hover:scale-105 transition flex flex-col items-center justify-center text-center relative overflow-hidden group">
                                            <div className="absolute inset-0 bg-black/10 group-hover:bg-transparent transition"></div>
                                            <ShoppingCart size={32} className="mb-2 text-rucher-yellow"/>
                                            <h3 className="font-serif text-2xl">Caisse Rapide</h3>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                                            <span className="text-rucher-green uppercase text-xs font-bold tracking-widest mb-2">Recettes</span>
                                            <span className="font-serif text-4xl text-green-600">+{dashboardData.totalSalesYear.toFixed(0)}‚Ç¨</span>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center">
                                            <span className="text-rucher-green uppercase text-xs font-bold tracking-widest mb-2">D√©penses</span>
                                            <span className="font-serif text-4xl text-red-600">-{dashboardData.totalExpensesYear.toFixed(0)}‚Ç¨</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'BREEDING' && <BreedingRegister />}
                            {view === 'HONEY' && <HoneyTraceability initialTab={honeyTab} />}
                            {view === 'EXPENSES' && <Expenses />}
                            {view === 'CLIENTS' && <ClientManager />}
                            
                            {view === 'SETTINGS' && (
                                <div className="bg-white p-8 rounded-xl shadow-sm max-w-2xl mx-auto border border-gray-100">
                                    <h2 className="font-serif text-2xl text-rucher-dark mb-6 border-b border-rucher-yellow pb-2">Param√®tres</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-rucher-green uppercase mb-1">Nom Exploitation</label>
                                            <input type="text" className="w-full border p-3 rounded bg-rucher-bg text-rucher-dark font-serif" value={profile.companyName||''} onChange={e=>{const p={...profile, companyName:e.target.value}; setProfile(p); Storage.saveProfile(p);}} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-rucher-green uppercase mb-1">SIRET</label>
                                            <input type="text" className="w-full border p-3 rounded bg-rucher-bg text-rucher-dark font-serif" value={profile.siret||''} onChange={e=>{const p={...profile, siret:e.target.value}; setProfile(p); Storage.saveProfile(p);}} />
                                        </div>
                                        <div className="pt-6 border-t mt-4">
                                            <h3 className="font-bold mb-4">Export PDF & Donn√©es</h3>
                                            <div className="grid grid-cols-2 gap-2 mb-4">
                                                 <button onClick={() => PDFService.generateBreedingRegisterPDF('2024-01-01', '2025-12-31')} className="bg-red-50 text-red-700 border border-red-200 px-3 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2">
                                                     <FileText size={14}/> Registre √âlevage
                                                 </button>
                                                 <button onClick={() => PDFService.generateHoneyTraceabilityPDF('2024-01-01', '2025-12-31')} className="bg-amber-50 text-amber-700 border border-amber-200 px-3 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2">
                                                     <FileText size={14}/> Cahier Miellerie
                                                 </button>
                                            </div>

                                            <button onClick={() => {
                                                const data = Storage.exportAllData();
                                                const blob = new Blob([data], {type: 'application/json'});
                                                const url = URL.createObjectURL(blob);
                                                const a = document.createElement('a');
                                                a.href = url;
                                                a.download = `backup_apigest_${new Date().toISOString().split('T')[0]}.json`;
                                                a.click();
                                            }} className="w-full bg-gray-100 text-gray-600 py-3 rounded font-bold flex items-center justify-center gap-2 hover:bg-gray-200 transition mb-2">
                                                <Download size={18}/> Sauvegarder mes donn√©es
                                            </button>
                                            
                                            <label className="w-full bg-blue-50 text-blue-600 py-3 rounded font-bold flex items-center justify-center gap-2 hover:bg-blue-100 transition cursor-pointer">
                                                <Upload size={18}/> Restaurer une sauvegarde
                                                <input type="file" accept=".json" className="hidden" onChange={(e) => {
                                                    const file = e.target.files[0];
                                                    if(file) {
                                                        const reader = new FileReader();
                                                        reader.onload = (ev) => {
                                                            if(Storage.importAllData(ev.target.result)) {
                                                                alert('Restauration r√©ussie !');
                                                                window.location.reload();
                                                            } else {
                                                                alert('Fichier invalide');
                                                            }
                                                        };
                                                        reader.readAsText(file);
                                                    }
                                                }}/>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>